<div class="page">
  <div class="header">
    <div class="title">
      <h1>Reglas de financiamiento por manzana</h1>
      <p>Define si es contado o el plazo máximo permitido.</p>
    </div>
    <div class="header-actions">
      <button class="btn" (click)="downloadTemplate()">Descargar plantilla</button>
      <label class="btn">
        <input type="file" accept=".xlsx,.xls" (change)="onFileSelected($event)" hidden />
        {{ selectedFile ? selectedFile.name : 'Elegir Excel' }}
      </label>
      <label class="toggle">
        <input type="checkbox" [(ngModel)]="createMissingManzanas" />
        <span>Crear manzanas faltantes</span>
      </label>
      <button class="btn primary" (click)="importExcel()" [disabled]="!selectedFile || importing">
        {{ importing ? 'Importando...' : 'Importar' }}
      </button>
      <button class="btn" (click)="load()" [disabled]="loading">Recargar</button>
    </div>
  </div>

  <div class="card">
    <div class="loading" *ngIf="loading">Cargando...</div>

    <table class="table" *ngIf="!loading">
      <thead>
        <tr>
          <th>Manzana</th>
          <th>Tipo</th>
          <th>Máx. cuotas</th>
          <th>CI mínima %</th>
          <th>C. balón</th>
          <th>Bono BPP</th>
          <th class="actions">Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let row of rows">
          <td class="manzana">{{ row.manzana_name }}</td>
          <td>
            <select [(ngModel)]="row.financing_type" (ngModelChange)="onTypeChange(row)">
              <option [ngValue]="undefined">Sin configurar</option>
              <option *ngFor="let o of financingTypeOptions" [ngValue]="o.value">{{ o.label }}</option>
            </select>
          </td>
          <td>
            <select [(ngModel)]="row.max_installments" [disabled]="row.financing_type === 'cash_only' || !row.financing_type">
              <option [ngValue]="null">-</option>
              <option *ngFor="let i of installmentOptions" [ngValue]="i">{{ i }}</option>
            </select>
          </td>
          <td>
            <input
              type="number"
              min="0"
              max="100"
              step="0.01"
              [(ngModel)]="row.min_down_payment_percentage"
              placeholder="-"
            />
          </td>
          <td class="center">
            <input type="checkbox" [(ngModel)]="row.allows_balloon_payment" />
          </td>
          <td class="center">
            <input type="checkbox" [(ngModel)]="row.allows_bpp_bonus" />
          </td>
          <td class="actions">
            <button class="btn primary" (click)="save(row)" [disabled]="!canSave(row) || row.saving">
              {{ row.ruleId ? 'Actualizar' : 'Crear' }}
            </button>
            <button class="btn danger" (click)="remove(row)" [disabled]="!row.ruleId || row.saving">
              Eliminar
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
