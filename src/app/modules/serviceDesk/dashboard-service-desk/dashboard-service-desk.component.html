<!-- Selector de periodo -->
<div class="flex items-center gap-2 mb-6 p-4 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700">
    <label class="text-xs text-gray-400 dark:text-gray-300">Periodo:</label>
    <select [(ngModel)]="period" (change)="onPeriodChange()" class="bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
        <option value="today">Hoy</option>
        <option value="week">Esta semana</option>
        <option value="month">Este mes</option>
        <option value="custom">Personalizado</option>
    </select>
    <ng-container *ngIf="period === 'custom'">
        <input type="date" [(ngModel)]="customStart" (change)="onPeriodChange()" class="bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5" />
        <span class="mx-1 text-gray-400 dark:text-gray-300">a</span>
        <input type="date" [(ngModel)]="customEnd" (change)="onPeriodChange()" class="bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5" />
    </ng-container>
</div>

<!-- Rango personalizado incompleto -->
<div *ngIf="period === 'custom' && (!customStart || !customEnd)" class="flex flex-col items-center mt-10 p-8 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700">
    <lucide-icon [name]="calendar" class="w-14 h-14 text-gray-500 dark:text-gray-400 mb-3"></lucide-icon>
    <div class="text-lg text-gray-300 dark:text-gray-400 font-semibold">Selecciona ambas fechas para ver el análisis</div>
    <div class="text-sm text-gray-500 dark:text-gray-500">Completa el rango personalizado para mostrar los datos del dashboard.</div>
</div>

<!-- Dashboard principal -->
<div *ngIf="period !== 'custom' || (customStart && customEnd)">

    <!-- KPIs -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
        <div
            class="rounded-2xl border border-slate-700 dark:border-gray-600 bg-slate-950 dark:bg-gray-800 px-6 py-5 flex flex-col text-white min-w-[230px] shadow-sm">
            <div class="flex justify-between items-center mb-1">
                <span class="font-semibold">Total Tickets</span>
                <lucide-icon [name]="ticket" class="w-7 h-7 text-indigo-400"></lucide-icon>
            </div>
            <div class="text-4xl font-extrabold my-2 tracking-tight">{{ data.total_tickets || 0 }}</div>
            <div class="text-xs text-gray-400 font-medium">+{{ data.variation_tickets || 0 }}% vs mes anterior</div>
        </div>
        <div class="rounded-2xl border border-red-700 dark:border-red-600 bg-slate-950 dark:bg-gray-800 px-6 py-5 flex flex-col text-white shadow-sm">
            <div class="flex justify-between items-center mb-1">
                <span class="font-semibold">Tickets Abiertos</span>
                <lucide-icon [name]="alert_triangle" class="w-7 h-7 text-red-400"></lucide-icon>
            </div>
            <div class="text-4xl font-extrabold my-2 tracking-tight text-red-500">{{ data.open_tickets || 0 }}</div>
            <div class="text-xs text-red-400 font-medium">{{ data.open_tickets_note || '-' }}</div>
        </div>
        <div class="rounded-2xl border border-yellow-700 dark:border-yellow-600 bg-slate-950 dark:bg-gray-800 px-6 py-5 flex flex-col text-white shadow-sm">
            <div class="flex justify-between items-center mb-1">
                <span class="font-semibold">SLA Cumplido</span>
                <lucide-icon [name]="check_circle" class="w-7 h-7 text-yellow-400"></lucide-icon>
            </div>
            <div class="text-4xl font-extrabold my-2 tracking-tight text-yellow-300">{{ data.sla_rate || '0%' }}</div>
            <div class="text-xs text-yellow-400 font-medium">+{{ data.variation_sla || '0' }}% vs mes anterior</div>
        </div>
        <div class="rounded-2xl border border-cyan-700 dark:border-cyan-600 bg-slate-950 dark:bg-gray-800 px-6 py-5 flex flex-col text-white shadow-sm">
            <div class="flex justify-between items-center mb-1">
                <span class="font-semibold">Tiempo Promedio</span>
                <lucide-icon [name]="clock" class="w-7 h-7 text-cyan-400"></lucide-icon>
            </div>
            <div class="text-4xl font-extrabold my-2 tracking-tight text-cyan-300">{{ data.avg_time || '0h' }}</div>
            <div class="text-xs text-cyan-400 font-medium">{{ data.avg_time_note || '-' }}</div>
        </div>
    </div>

    <!-- Gráficos + Alertas -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-7 mt-3 mb-2 w-full">
        <!-- Tickets por Estado -->
        <div class="rounded-2xl border border-slate-800 dark:border-gray-700 bg-slate-950 dark:bg-gray-800 p-6 flex flex-col items-center justify-center min-h-[330px] shadow-lg relative w-full
                  max-w-[420px] lg:max-w-full mx-auto lg:mx-0 transition-all">
            <h4 class="font-semibold mb-2 self-start text-base text-white dark:text-gray-100">Tickets por Estado</h4>
            <canvas baseChart [data]="statusChartData" [type]="'doughnut'" [options]="{
          responsive: true,
          cutout: '68%',
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                color: 'white',
                font: { size: 15, family: 'Inter, Roboto, sans-serif' },
                boxWidth: 20,
                padding: 12
              }
            }
          }
        }" width="310" height="180" class="!max-w-[310px] !max-h-[180px] mx-auto select-none"></canvas>
        </div>
        <!-- Tickets por Prioridad -->
        <div class="rounded-2xl border border-slate-800 dark:border-gray-700 bg-slate-950 dark:bg-gray-800 p-6 flex flex-col items-center justify-center min-h-[330px] shadow-lg relative w-full
                  max-w-[420px] lg:max-w-full mx-auto lg:mx-0 transition-all">
            <h4 class="font-semibold mb-2 self-start text-base text-white dark:text-gray-100">Tickets por Prioridad</h4>
            <canvas baseChart [data]="priorityChartData" [type]="'bar'" [options]="{
          responsive: true,
          plugins: {
            legend: { display: false, labels: { color: 'white' } }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { color: 'white', font: { size: 13 }, precision: 0 },
              grid: { color: '#33415544' }
            },
            x: {
              ticks: { color: 'white', font: { size: 13 } },
              grid: { color: '#33415544' }
            }
          }
        }" width="310" height="180" class="!max-w-[310px] !max-h-[180px] mx-auto select-none"></canvas>
        </div>
        <!-- Alertas -->
        <div class="rounded-2xl border border-slate-800 dark:border-gray-700 bg-slate-950 dark:bg-gray-800 p-6 text-white dark:text-gray-100 shadow-lg flex flex-col justify-start min-h-[330px] w-full
                  max-w-[420px] lg:max-w-full mx-auto lg:mx-0 transition-all">
            <h4 class="font-semibold mb-3 text-base">Alertas</h4>
            <ng-container *ngIf="alerts?.length; else noAlerts">
                <div *ngFor="let alert of alerts" class="flex items-center mb-3 p-2 rounded bg-opacity-20" [ngClass]="{
            'bg-red-700 text-red-300': alert.type === 'danger',
            'bg-yellow-700 text-yellow-300': alert.type === 'warning',
            'bg-cyan-700 text-cyan-300': alert.type === 'info'
          }">
                    <lucide-icon [name]="alert.icon" class="w-5 h-5 mr-2"></lucide-icon>
                    <span class="ml-1 text-sm">{{ alert.message }}</span>
                </div>
            </ng-container>
            <ng-template #noAlerts>
                <div class="flex flex-col items-center justify-center h-full text-gray-400 opacity-60 pt-8">
                    <lucide-icon name="bell-minus" class="w-10 h-10 mb-2"></lucide-icon>
                    <span class="text-sm">Sin alertas en este periodo</span>
                </div>
            </ng-template>
        </div>
    </div>

    <!-- Tickets recientes y técnicos top -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-9">
        <!-- Tickets recientes -->
        <div class="md:col-span-2 rounded-2xl border border-slate-800 dark:border-gray-700 bg-slate-950 dark:bg-gray-800 p-6 text-white dark:text-gray-100 shadow-sm">
            <div class="flex justify-between items-center mb-4">
                <h4 class="font-semibold text-base">Tickets Recientes</h4>
                <a routerLink="/service-desk/tickets" class="text-indigo-400 dark:text-indigo-300 underline text-sm hover:text-indigo-300 dark:hover:text-indigo-200">Ver todos</a>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-white dark:text-gray-100 border-separate border-spacing-y-2">
                    <thead>
                        <tr class="text-xs text-slate-400 dark:text-gray-400 font-semibold bg-slate-900 dark:bg-gray-700">
                            <th class="py-1">ID</th>
                            <th>Descripción</th>
                            <th>Prioridad</th>
                            <th>Estado</th>
                            <th>Creado</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let t of recentTickets" class="bg-slate-900/60 dark:bg-gray-700/60">
                            <td class="font-mono tracking-widest text-xs py-2">{{ t.ticket_id }}</td>
                            <td class="text-sm truncate max-w-[260px]" title="{{ t.description }}">{{ t.description }}
                            </td>
                            <td>
                                <span class="px-2 py-1 rounded-full text-xs font-semibold" [ngClass]="{
                    'bg-red-700 text-red-100': t.priority === 'alta',
                    'bg-yellow-700 text-yellow-100': t.priority === 'media',
                    'bg-cyan-700 text-cyan-100': t.priority === 'baja',
                    'bg-pink-700 text-pink-100': t.priority === 'critica'
                  }">{{ t.priority | titlecase }}</span>
                            </td>
                            <td>
                                <span class="px-2 py-1 rounded-full text-xs font-semibold" [ngClass]="{
                    'bg-blue-700 text-blue-100': t.status === 'abierto',
                    'bg-yellow-700 text-yellow-100': t.status === 'en_proceso',
                    'bg-green-700 text-green-100': t.status === 'cerrado'
                  }">{{ t.status | titlecase }}</span>
                            </td>
                            <td class="text-xs">{{ t.created_at | date:'short' }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <!-- Técnicos más activos -->
        <div class="rounded-2xl border border-slate-800 dark:border-gray-700 bg-slate-950 dark:bg-gray-800 p-6 text-white dark:text-gray-100 shadow-sm h-fit">
            <h4 class="font-semibold mb-3 text-base">Técnicos más activos</h4>
            <div *ngFor="let tech of topTechs" class="flex justify-between items-center mb-2">
                <span class="text-sm font-medium">{{ tech.username }}</span>
                <span class="badge bg-indigo-700 dark:bg-indigo-600 px-3 py-1 rounded-full text-xs text-white">{{ tech.assigned_tickets_count || 0 }}
                    tickets</span>
            </div>
        </div>
    </div>
</div>
  