<div class="min-h-screen p-6">
    <ng-container *ngIf="ticket$ | async as ticket">
        <!-- Header -->
        <div
            class="flex flex-wrap justify-between items-center gap-4 pb-6 mb-6 border-b border-gray-200 dark:border-gray-700">
            <div class="flex items-center gap-3">
                <button (click)="router.navigate(['/service-desk/tickets'])"
                    class="flex items-center justify-center w-10 h-10 rounded-xl text-gray-400 hover:text-indigo-500 hover:bg-indigo-50 dark:hover:bg-indigo-900/20 transition-all">
                    <lucide-icon name="arrow-left" class="w-6 h-6"></lucide-icon>
                </button>
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Ticket #{{ ticket.ticket_id }}</h2>
                <span *ngIf="ticket.priority === 'alta' || ticket.priority === 'critica'"
                    class="px-2.5 py-1 rounded-full text-xs font-semibold text-white" [ngClass]="{
                        'bg-gradient-to-r from-red-500 to-red-600': ticket.priority === 'alta',
                        'bg-gradient-to-r from-pink-500 to-rose-600 animate-pulse': ticket.priority === 'critica'
                    }">
                    {{ ticket.priority | titlecase }}
                </span>
            </div>
            <div class="flex items-center gap-2">
                <button (click)="onEdit(ticket)"
                    class="flex items-center gap-1 px-4 py-2 rounded-xl text-sm font-medium text-indigo-500 border border-indigo-200 dark:border-indigo-800 bg-indigo-50 dark:bg-indigo-900/20 hover:bg-indigo-100 dark:hover:bg-indigo-900/40 transition-all">
                    <lucide-icon name="pencil" class="w-4 h-4"></lucide-icon>
                    Editar
                </button>
                <button (click)="openAddAction(ticket)"
                    class="flex items-center gap-1 px-4 py-2 rounded-xl text-sm font-medium text-green-500 border border-green-200 dark:border-green-800 bg-green-50 dark:bg-green-900/20 hover:bg-green-100 dark:hover:bg-green-900/40 transition-all">
                    <lucide-icon name="plus-circle" class="w-4 h-4"></lucide-icon>
                    Agregar Acción
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <!-- Main Content -->
            <div class="lg:col-span-8 space-y-6">
                <!-- Ticket Info Card -->
                <div
                    class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-lg border border-gray-100 dark:border-gray-700">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-lg font-bold text-gray-800 dark:text-white">Información del Ticket</h4>
                        <span class="px-2.5 py-1 rounded-full text-xs font-semibold" [ngClass]="{
                                'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400': ticket.status === 'abierto',
                                'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400': ticket.status === 'en_proceso',
                                'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400': ticket.status === 'cerrado'
                            }">
                            {{ getStatusLabel(ticket.status) }}
                        </span>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div class="space-y-2">
                            <p class="text-gray-600 dark:text-gray-300"><span
                                    class="text-gray-400 dark:text-gray-500">ID:</span> #{{ ticket.ticket_id }}</p>
                            <p class="text-gray-600 dark:text-gray-300">
                                <span class="text-gray-400 dark:text-gray-500">Tipo:</span>
                                <span
                                    class="ml-1 px-2 py-0.5 rounded text-xs font-medium bg-indigo-100 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-400">
                                    {{ ticket.ticket_type | titlecase }}
                                </span>
                            </p>
                            <p class="text-gray-600 dark:text-gray-300"><span
                                    class="text-gray-400 dark:text-gray-500">Creado por:</span> {{
                                ticket.opened_by?.first_name }} {{ ticket.opened_by?.last_name }}</p>
                            <p class="text-gray-600 dark:text-gray-300"><span
                                    class="text-gray-400 dark:text-gray-500">Fecha apertura:</span> {{ ticket.opened_at
                                | date: 'dd/MM/yyyy HH:mm' }}</p>
                        </div>
                        <div class="space-y-2">
                            <p class="text-gray-600 dark:text-gray-300">
                                <span class="text-gray-400 dark:text-gray-500">Contrato:</span>
                                <ng-container *ngIf="ticket.contract_id && ticket.contract; else noContract">
                                    #{{ ticket.contract.contract_id }}
                                </ng-container>
                                <ng-template #noContract><span class="text-gray-400">Sin contrato</span></ng-template>
                            </p>
                            <p class="text-gray-600 dark:text-gray-300">
                                <span class="text-gray-400 dark:text-gray-500">SLA vence:</span>
                                <span
                                    [ngClass]="{ 'text-red-500': isSlaExpired(ticket), 'text-yellow-500': isSlaWarning(ticket) }">
                                    {{ ticket.sla_due_at ? (ticket.sla_due_at | date: 'dd/MM/yyyy HH:mm') : '--' }}
                                </span>
                            </p>
                            <p class="text-gray-600 dark:text-gray-300">
                                <span class="text-gray-400 dark:text-gray-500">Escalado:</span>
                                <span *ngIf="ticket.escalated_at" class="text-yellow-500">Sí</span>
                                <span *ngIf="!ticket.escalated_at" class="text-gray-400">No</span>
                            </p>
                            <p class="text-gray-600 dark:text-gray-300">
                                <span class="text-gray-400 dark:text-gray-500">Asignado a:</span>
                                <span *ngIf="ticket.assigned_to">{{ ticket.assigned_to.first_name }} {{
                                    ticket.assigned_to.last_name }}</span>
                                <span *ngIf="!ticket.assigned_to" class="text-gray-400">Sin asignar</span>
                            </p>
                        </div>
                    </div>

                    <div class="mt-4 pt-4 border-t border-gray-100 dark:border-gray-700">
                        <h6 class="text-sm font-semibold text-gray-800 dark:text-white mb-2">Descripción</h6>
                        <p class="text-sm text-gray-600 dark:text-gray-400 leading-relaxed">{{ ticket.description ||
                            'Sin descripción.' }}</p>
                    </div>
                </div>

                <!-- Action History -->
                <div
                    class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-lg border border-gray-100 dark:border-gray-700">
                    <h4 class="text-lg font-bold text-gray-800 dark:text-white mb-4">Historial de Acciones</h4>

                    <ng-container *ngIf="ticket.actions && ticket.actions.length > 0; else noActions">
                        <div class="relative pl-8 space-y-6">
                            <div class="absolute left-4 top-0 bottom-0 w-0.5 bg-gray-200 dark:bg-gray-700"></div>
                            <div *ngFor="let action of ticket.actions" class="relative">
                                <div class="absolute -left-8 w-8 h-8 rounded-full flex items-center justify-center text-white"
                                    [ngClass]="{
                                        'bg-gradient-to-br from-indigo-500 to-indigo-600': action.action_type === 'comentario',
                                        'bg-gradient-to-br from-yellow-500 to-amber-500': action.action_type === 'cambio_estado',
                                        'bg-gradient-to-br from-pink-500 to-rose-500': action.action_type === 'escalado',
                                        'bg-gradient-to-br from-cyan-500 to-cyan-600': action.action_type === 'asignacion'
                                    }">
                                    <lucide-icon [name]="getActionIcon(action.action_type)"
                                        class="w-4 h-4"></lucide-icon>
                                </div>
                                <div class="pl-4">
                                    <div class="flex justify-between items-center mb-1">
                                        <h6 class="text-sm font-semibold text-gray-800 dark:text-white">{{
                                            getActionTitle(action.action_type) }}</h6>
                                        <span class="text-xs text-gray-400">{{ action.created_at | date: 'dd/MM/yyyy
                                            HH:mm' }}</span>
                                    </div>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mb-2">Por: {{
                                        action.user?.first_name }} {{ action.user?.last_name }}</p>
                                    <div *ngIf="action.notes"
                                        class="text-sm text-gray-600 dark:text-gray-300 p-3 rounded-lg bg-gray-50 dark:bg-gray-700/50">
                                        {{ action.notes }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </ng-container>
                    <ng-template #noActions>
                        <div class="flex flex-col items-center justify-center py-8 text-center">
                            <div
                                class="w-16 h-16 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center mb-4">
                                <lucide-icon name="message-circle" class="w-8 h-8 text-gray-400"></lucide-icon>
                            </div>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Sin acciones registradas</p>
                        </div>
                    </ng-template>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="lg:col-span-4 space-y-6">
                <!-- Metrics -->
                <div
                    class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-lg border border-gray-100 dark:border-gray-700">
                    <h4 class="text-lg font-bold text-gray-800 dark:text-white mb-4">Métricas</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="text-center p-3 rounded-xl bg-gray-50 dark:bg-gray-700/50">
                            <div class="text-2xl font-bold text-red-500">{{ calcElapsedTime(ticket) }}</div>
                            <div class="text-xs text-gray-400 mt-1">Tiempo transcurrido</div>
                        </div>
                        <div class="text-center p-3 rounded-xl bg-gray-50 dark:bg-gray-700/50">
                            <div class="text-2xl font-bold text-yellow-500">{{ calcSlaLeft(ticket) }}</div>
                            <div class="text-xs text-gray-400 mt-1">Tiempo SLA</div>
                        </div>
                        <div class="text-center p-3 rounded-xl bg-gray-50 dark:bg-gray-700/50">
                            <div class="text-2xl font-bold text-cyan-500">{{ ticket.actions?.length || 0 }}</div>
                            <div class="text-xs text-gray-400 mt-1">Acciones</div>
                        </div>
                        <div class="text-center p-3 rounded-xl bg-gray-50 dark:bg-gray-700/50">
                            <div class="text-2xl font-bold text-green-500">{{ getEscalations(ticket) }}</div>
                            <div class="text-xs text-gray-400 mt-1">Escalaciones</div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div
                    class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-lg border border-gray-100 dark:border-gray-700">
                    <h4 class="text-lg font-bold text-gray-800 dark:text-white mb-4">Acciones Rápidas</h4>
                    <div class="space-y-2">
                        <button (click)="openMarkAsResolved(ticket)" [disabled]="ticket.status === 'cerrado'"
                            class="flex items-center gap-2 w-full px-4 py-3 rounded-xl text-sm font-medium text-left text-green-600 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 hover:bg-green-100 dark:hover:bg-green-900/40 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                            <lucide-icon name="check-circle" class="w-5 h-5"></lucide-icon>
                            Marcar como Resuelto
                        </button>
                        <button (click)="openEscalateModal(ticket)" [disabled]="ticket.status === 'cerrado'"
                            class="flex items-center gap-2 w-full px-4 py-3 rounded-xl text-sm font-medium text-left text-yellow-600 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 hover:bg-yellow-100 dark:hover:bg-yellow-900/40 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                            <lucide-icon name="arrow-up-circle" class="w-5 h-5"></lucide-icon>
                            Escalar Ticket
                        </button>
                        <button (click)="openAssignTechModal(ticket)" [disabled]="ticket.status === 'cerrado'"
                            class="flex items-center gap-2 w-full px-4 py-3 rounded-xl text-sm font-medium text-left text-cyan-600 bg-cyan-50 dark:bg-cyan-900/20 border border-cyan-200 dark:border-cyan-800 hover:bg-cyan-100 dark:hover:bg-cyan-900/40 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                            <lucide-icon name="user-plus" class="w-5 h-5"></lucide-icon>
                            Asignar Técnico
                        </button>
                        <button (click)="openAddAction(ticket)" [disabled]="ticket.status === 'cerrado'"
                            class="flex items-center gap-2 w-full px-4 py-3 rounded-xl text-sm font-medium text-left text-indigo-600 bg-indigo-50 dark:bg-indigo-900/20 border border-indigo-200 dark:border-indigo-800 hover:bg-indigo-100 dark:hover:bg-indigo-900/40 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                            <lucide-icon name="message-square-plus" class="w-5 h-5"></lucide-icon>
                            Agregar Comentario
                        </button>
                    </div>
                </div>

                <!-- Contract Info -->
                <div *ngIf="ticket.contract_id && ticket.contract"
                    class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-lg border border-gray-100 dark:border-gray-700">
                    <h4 class="text-lg font-bold text-gray-800 dark:text-white mb-4">Contrato Asociado</h4>
                    <p class="text-sm text-gray-600 dark:text-gray-300">
                        <span class="text-gray-400 dark:text-gray-500">ID:</span> #{{ ticket.contract.contract_id }}
                    </p>
                </div>
            </div>
        </div>
    </ng-container>
</div>

<!-- Action Modal -->
<div *ngIf="showActionModal"
    class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm"
    (click)="closeActionModal()">
    <div class="w-full max-w-md bg-white dark:bg-gray-800 rounded-2xl shadow-2xl border border-gray-100 dark:border-gray-700"
        (click)="$event.stopPropagation()">
        <div class="flex items-center justify-between p-5 border-b border-gray-100 dark:border-gray-700">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-white">{{ actionModalTitle }}</h3>
            <button (click)="closeActionModal()"
                class="flex items-center justify-center w-8 h-8 rounded-lg text-gray-400 hover:text-gray-800 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 transition-all">
                <lucide-icon name="x" class="w-5 h-5"></lucide-icon>
            </button>
        </div>
        <div class="p-5 space-y-4">
            <div *ngIf="actionModalType === 'add'">
                <label class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 block">Tipo de Acción</label>
                <select [(ngModel)]="newActionType"
                    class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 text-gray-800 dark:text-white text-sm rounded-lg px-4 py-3 focus:ring-2 focus:ring-indigo-500">
                    <option value="comentario">Comentario</option>
                    <option value="cambio_estado">Cambio de Estado</option>
                    <option value="escalado">Escalación</option>
                    <option value="asignacion">Asignación</option>
                </select>
            </div>
            <div *ngIf="actionModalType === 'assign'">
                <label class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 block">Seleccionar
                    Técnico</label>
                <select [(ngModel)]="selectedTechId"
                    class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 text-gray-800 dark:text-white text-sm rounded-lg px-4 py-3 focus:ring-2 focus:ring-indigo-500">
                    <option [ngValue]="null">Seleccionar...</option>
                    <option *ngFor="let tech of technicians" [value]="tech.user_id">{{ tech.first_name }} {{
                        tech.last_name }}</option>
                </select>
            </div>
            <div>
                <label class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 block">
                    {{ actionModalType === 'add' ? 'Notas' : 'Motivo / Comentario' }}
                </label>
                <textarea [(ngModel)]="actionNotes" rows="4" placeholder="Escribe aquí..."
                    class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 text-gray-800 dark:text-white text-sm rounded-lg px-4 py-3 focus:ring-2 focus:ring-indigo-500 resize-none"></textarea>
            </div>
        </div>
        <div class="flex items-center justify-end gap-3 p-5 border-t border-gray-100 dark:border-gray-700">
            <button (click)="closeActionModal()"
                class="px-4 py-2 rounded-lg text-sm font-medium text-gray-500 dark:text-gray-400 hover:text-gray-800 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 transition-all">
                Cancelar
            </button>
            <button (click)="submitAction()" [disabled]="actionLoading"
                class="flex items-center gap-2 px-5 py-2 rounded-lg text-sm font-semibold text-white bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 shadow-lg transition-all disabled:opacity-50">
                <lucide-icon *ngIf="actionLoading" name="loader-2" class="w-4 h-4 animate-spin"></lucide-icon>
                {{ actionLoading ? 'Guardando...' : 'Confirmar' }}
            </button>
        </div>
    </div>
</div>