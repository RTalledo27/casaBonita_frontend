<div class="payment-verification-manager">
  <!-- Header con estadísticas -->
  <div class="header-section mb-6">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-2xl font-bold text-gray-900">Gestión de Verificaciones de Comisiones</h2>
      <div class="flex gap-2">
        <button 
          mat-raised-button 
          color="primary" 
          (click)="processAutomaticVerifications()"
          [disabled]="loading">
          <mat-icon>autorenew</mat-icon>
          Procesar Automáticas
        </button>
        <button 
          mat-stroked-button 
          (click)="exportData()">
          <mat-icon>download</mat-icon>
          Exportar
        </button>
      </div>
    </div>
    
    <!-- Tarjetas de estadísticas -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4" *ngIf="stats">
      <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
        <div class="flex items-center">
          <mat-icon class="text-yellow-600 mr-2">pending</mat-icon>
          <div>
            <p class="text-sm font-medium text-yellow-800">Pendientes</p>
            <p class="text-2xl font-bold text-yellow-900">{{ stats.total_pending }}</p>
            <p class="text-xs text-yellow-600">${{ stats.pending_amount | currency:'USD':'symbol':'1.2-2' }}</p>
          </div>
        </div>
      </div>
      
      <div class="bg-green-50 border border-green-200 rounded-lg p-4">
        <div class="flex items-center">
          <mat-icon class="text-green-600 mr-2">check_circle</mat-icon>
          <div>
            <p class="text-sm font-medium text-green-800">Verificadas</p>
            <p class="text-2xl font-bold text-green-900">{{ stats.total_verified }}</p>
            <p class="text-xs text-green-600">${{ stats.verified_amount | currency:'USD':'symbol':'1.2-2' }}</p>
          </div>
        </div>
      </div>
      
      <div class="bg-red-50 border border-red-200 rounded-lg p-4">
        <div class="flex items-center">
          <mat-icon class="text-red-600 mr-2">error</mat-icon>
          <div>
            <p class="text-sm font-medium text-red-800">Fallidas</p>
            <p class="text-2xl font-bold text-red-900">{{ stats.total_failed }}</p>
          </div>
        </div>
      </div>
      
      <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
        <div class="flex items-center">
          <mat-icon class="text-blue-600 mr-2">assessment</mat-icon>
          <div>
            <p class="text-sm font-medium text-blue-800">Total</p>
            <p class="text-2xl font-bold text-blue-900">{{ stats.total_pending + stats.total_verified + stats.total_failed }}</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Filtros de búsqueda -->
  <mat-card class="filters-card">
    <mat-card-content>
      <div class="filters-grid">
        <!-- Búsqueda por texto -->
        <mat-form-field appearance="outline">
          <mat-label>Buscar</mat-label>
          <input matInput 
                 placeholder="Cliente, empleado, contrato..." 
                 [formControl]="searchControl">
          <mat-icon matSuffix>search</mat-icon>
        </mat-form-field>
        
        <!-- Filtro por estado -->
        <mat-form-field appearance="outline">
          <mat-label>Estado</mat-label>
          <mat-select [formControl]="statusFilter" multiple>
            <mat-option value="pending">Pendiente</mat-option>
            <mat-option value="verified">Verificado</mat-option>
            <mat-option value="failed">Fallido</mat-option>
            <mat-option value="processing">Procesando</mat-option>
          </mat-select>
        </mat-form-field>
        
        <!-- Filtro por empleado -->
        <mat-form-field appearance="outline">
          <mat-label>Empleado</mat-label>
          <mat-select [formControl]="employeeFilter">
            <mat-option value="">Todos</mat-option>
            <mat-option *ngFor="let employee of employees" [value]="employee.id">
              {{ employee.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>
        
        <!-- Filtro por cliente -->
        <mat-form-field appearance="outline">
          <mat-label>Cliente</mat-label>
          <mat-select [formControl]="clientFilter">
            <mat-option value="">Todos</mat-option>
            <mat-option *ngFor="let client of clients" [value]="client.id">
              {{ client.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>
        
        <!-- Filtro por rango de montos -->
        <mat-form-field appearance="outline">
          <mat-label>Monto mínimo</mat-label>
          <input matInput 
                 type="number" 
                 placeholder="0" 
                 [formControl]="minAmountFilter">
          <span matPrefix>$&nbsp;</span>
        </mat-form-field>
        
        <mat-form-field appearance="outline">
          <mat-label>Monto máximo</mat-label>
          <input matInput 
                 type="number" 
                 placeholder="Sin límite" 
                 [formControl]="maxAmountFilter">
          <span matPrefix>$&nbsp;</span>
        </mat-form-field>
        
        <!-- Filtro por rango de fechas -->
        <mat-form-field appearance="outline">
          <mat-label>Fecha desde</mat-label>
          <input matInput 
                 [matDatepicker]="startDatePicker" 
                 [formControl]="startDateFilter">
          <mat-datepicker-toggle matSuffix [for]="startDatePicker"></mat-datepicker-toggle>
          <mat-datepicker #startDatePicker></mat-datepicker>
        </mat-form-field>
        
        <mat-form-field appearance="outline">
          <mat-label>Fecha hasta</mat-label>
          <input matInput 
                 [matDatepicker]="endDatePicker" 
                 [formControl]="endDateFilter">
          <mat-datepicker-toggle matSuffix [for]="endDatePicker"></mat-datepicker-toggle>
          <mat-datepicker #endDatePicker></mat-datepicker>
        </mat-form-field>
        
        <!-- Filtros rápidos -->
        <div class="quick-filters">
          <mat-chip-listbox aria-label="Filtros rápidos">
            <mat-chip-option (click)="applyQuickFilter('today')" [selected]="quickFilter === 'today'">
              Hoy
            </mat-chip-option>
            <mat-chip-option (click)="applyQuickFilter('week')" [selected]="quickFilter === 'week'">
              Esta semana
            </mat-chip-option>
            <mat-chip-option (click)="applyQuickFilter('month')" [selected]="quickFilter === 'month'">
              Este mes
            </mat-chip-option>
            <mat-chip-option (click)="applyQuickFilter('pending_only')" [selected]="quickFilter === 'pending_only'">
              Solo pendientes
            </mat-chip-option>
          </mat-chip-listbox>
        </div>
        
        <!-- Botones de acción -->
        <div class="filter-actions">
          <button mat-raised-button color="primary" (click)="applyFilters()" [disabled]="loading">
            <mat-icon>filter_list</mat-icon>
            Aplicar Filtros
          </button>
          <button mat-button (click)="clearFilters()" [disabled]="loading">
            <mat-icon>clear</mat-icon>
            Limpiar
          </button>
          <button mat-button (click)="exportResults()" [disabled]="loading || dataSource.data.length === 0">
            <mat-icon>download</mat-icon>
            Exportar
          </button>
        </div>
      </div>
      
      <!-- Resumen de filtros activos -->
      <div class="active-filters" *ngIf="hasActiveFilters()">
        <span class="filter-label">Filtros activos:</span>
        <mat-chip-listbox>
          <mat-chip-option *ngIf="searchControl.value" (removed)="clearSearchFilter()">
            Búsqueda: "{{ searchControl.value }}"
            <mat-icon matChipRemove>cancel</mat-icon>
          </mat-chip-option>
          <mat-chip-option *ngIf="statusFilter.value?.length" (removed)="clearStatusFilter()">
            Estados: {{ getStatusFilterText() }}
            <mat-icon matChipRemove>cancel</mat-icon>
          </mat-chip-option>
          <mat-chip-option *ngIf="employeeFilter.value" (removed)="clearEmployeeFilter()">
            Empleado: {{ getEmployeeName(employeeFilter.value) }}
            <mat-icon matChipRemove>cancel</mat-icon>
          </mat-chip-option>
          <mat-chip-option *ngIf="clientFilter.value" (removed)="clearClientFilter()">
            Cliente: {{ getClientName(clientFilter.value) }}
            <mat-icon matChipRemove>cancel</mat-icon>
          </mat-chip-option>
          <mat-chip-option *ngIf="minAmountFilter.value || maxAmountFilter.value" (removed)="clearAmountFilters()">
            Monto: {{ getAmountFilterText() }}
            <mat-icon matChipRemove>cancel</mat-icon>
          </mat-chip-option>
          <mat-chip-option *ngIf="startDateFilter.value || endDateFilter.value" (removed)="clearDateFilters()">
            Fechas: {{ getDateFilterText() }}
            <mat-icon matChipRemove>cancel</mat-icon>
          </mat-chip-option>
        </mat-chip-listbox>
      </div>
    </mat-card-content>
  </mat-card>
  
  <!-- Tabla de comisiones -->
  <mat-card>
    <mat-card-header>
      <mat-card-title>Comisiones Pendientes de Verificación</mat-card-title>
      <mat-card-subtitle>{{ totalRecords }} registros encontrados</mat-card-subtitle>
    </mat-card-header>
    
    <mat-card-content>
      <div class="table-container">
        <table mat-table [dataSource]="dataSource" matSort class="w-full">
          <!-- ID Comisión -->
          <ng-container matColumnDef="commission_id">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>ID</th>
            <td mat-cell *matCellDef="let element">
              <span class="font-mono text-sm">#{{ element.commission_id }}</span>
            </td>
          </ng-container>
          
          <!-- Empleado -->
          <ng-container matColumnDef="employee_name">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Empleado</th>
            <td mat-cell *matCellDef="let element">
              <div class="flex items-center">
                <mat-icon class="text-gray-400 mr-2">person</mat-icon>
                <span>{{ element.employee_name }}</span>
              </div>
            </td>
          </ng-container>
          
          <!-- Cliente -->
          <ng-container matColumnDef="client_name">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Cliente</th>
            <td mat-cell *matCellDef="let element">
              <div class="flex items-center">
                <mat-icon class="text-gray-400 mr-2">business</mat-icon>
                <span>{{ element.client_name }}</span>
              </div>
            </td>
          </ng-container>
          
          <!-- Contrato -->
          <ng-container matColumnDef="contract_id">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Contrato</th>
            <td mat-cell *matCellDef="let element">
              <span class="font-mono text-sm">#{{ element.contract_id }}</span>
            </td>
          </ng-container>
          
          <!-- Monto -->
          <ng-container matColumnDef="commission_amount">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Monto</th>
            <td mat-cell *matCellDef="let element">
              <span class="font-semibold text-green-600">
                {{ element.commission_amount | currency:'USD':'symbol':'1.2-2' }}
              </span>
            </td>
          </ng-container>
          
          <!-- Estado -->
          <ng-container matColumnDef="payment_verification_status">
            <th mat-header-cell *matHeaderCellDef>Estado</th>
            <td mat-cell *matCellDef="let element">
              <span 
                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border"
                [ngClass]="getStatusClass(element.payment_verification_status)">
                {{ getStatusText(element.payment_verification_status) }}
              </span>
            </td>
          </ng-container>
          
          <!-- Fecha -->
          <ng-container matColumnDef="created_at">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Fecha</th>
            <td mat-cell *matCellDef="let element">
              <span class="text-sm text-gray-600">
                {{ element.created_at | date:'dd/MM/yyyy' }}
              </span>
            </td>
          </ng-container>
          
          <!-- Acciones -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Acciones</th>
            <td mat-cell *matCellDef="let element">
              <div class="flex gap-2">
                <button 
                  mat-icon-button 
                  color="primary"
                  [disabled]="!canVerifyManually(element)"
                  (click)="openManualVerification(element)"
                  matTooltip="Verificar manualmente">
                  <mat-icon>check_circle</mat-icon>
                </button>
                
                <button 
                  mat-icon-button 
                  color="accent"
                  matTooltip="Ver detalles">
                  <mat-icon>visibility</mat-icon>
                </button>
              </div>
            </td>
          </ng-container>
          
          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>
        
        <!-- Loading spinner -->
        <div *ngIf="loading" class="flex justify-center items-center py-8">
          <mat-spinner diameter="40"></mat-spinner>
        </div>
        
        <!-- No data message -->
        <div *ngIf="!loading && dataSource.data.length === 0" class="text-center py-8">
          <mat-icon class="text-gray-400 text-6xl mb-4">inbox</mat-icon>
          <p class="text-gray-500 text-lg">No se encontraron comisiones pendientes de verificación</p>
          <p class="text-gray-400 text-sm">Intenta ajustar los filtros de búsqueda</p>
        </div>
      </div>
      
      <!-- Paginación -->
      <mat-paginator 
        [length]="totalRecords"
        [pageSize]="pageSize"
        [pageSizeOptions]="[5, 10, 25, 50]"
        (page)="onPageChange($event)"
        showFirstLastButtons>
      </mat-paginator>
    </mat-card-content>
  </mat-card>
</div>