<div class="min-h-screen bg-gray-50 dark:bg-gray-900 p-6">
    <!-- Header with Export Buttons -->
    <div class="mb-8">
        <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">Reportes de Ventas</h1>
                <p class="text-gray-600 dark:text-gray-400">Análisis detallado de ventas por asesor, oficina y período
                </p>
            </div>

            <!-- Export Buttons -->
            <div class="flex flex-wrap gap-2">
                <button (click)="exportMonthlyIncome()" [disabled]="isExporting()"
                    class="bg-gradient-to-r from-blue-600 to-blue-700 text-white px-4 py-2.5 rounded-lg hover:from-blue-700 hover:to-blue-800 transition-all shadow-md hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed flex items-center space-x-2">
                    <lucide-angular [img]="fileTextIcon" [size]="18"></lucide-angular>
                    <span class="font-medium">Ingresos Mensuales</span>
                    <lucide-angular [img]="infoIcon" [size]="16" (click)="ttMonthly.toggle($event)"></lucide-angular>
                </button>
                <app-tooltip-popover #ttMonthly text="Descarga Excel consolidado por asesor con columnas por mes y totales."></app-tooltip-popover>

                <button (click)="exportDetailedSales()" [disabled]="isExporting()"
                    class="bg-gradient-to-r from-green-600 to-green-700 text-white px-4 py-2.5 rounded-lg hover:from-green-700 hover:to-green-800 transition-all shadow-md hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed flex items-center space-x-2">
                    <lucide-angular [img]="fileTextIcon" [size]="18"></lucide-angular>
                    <span class="font-medium">Ventas Detalladas</span>
                    <lucide-angular [img]="infoIcon" [size]="16" (click)="ttDetailed.toggle($event)"></lucide-angular>
                </button>
                <app-tooltip-popover #ttDetailed text="Formato profesional: bloques de MES, REEMBOLSO y CUOTA INICIAL, MZ/LOTE desde external_code, separación unificada y montos en S/."></app-tooltip-popover>

                <button (click)="exportClientDetails()" [disabled]="isExporting()"
                    class="bg-gradient-to-r from-purple-600 to-purple-700 text-white px-4 py-2.5 rounded-lg hover:from-purple-700 hover:to-purple-800 transition-all shadow-md hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed flex items-center space-x-2">
                    <lucide-angular [img]="usersIcon" [size]="18"></lucide-angular>
                    <span class="font-medium">Detalles Clientes</span>
                    <lucide-angular [img]="infoIcon" [size]="16" (click)="ttClients.toggle($event)"></lucide-angular>
                </button>
                <app-tooltip-popover #ttClients text="Información integral de clientes: ocupación, ingresos, fuente y contrato."></app-tooltip-popover>

                <!-- Dropdown for other exports -->
                <div class="relative" #exportDropdown>
                    <button (click)="toggleExportMenu()"
                        class="bg-gray-700 dark:bg-gray-600 text-white px-4 py-2.5 rounded-lg hover:bg-gray-800 dark:hover:bg-gray-700 transition-colors flex items-center space-x-2">
                        <lucide-angular [img]="downloadIcon" [size]="18"></lucide-angular>
                        <span>Más</span>
                        <lucide-angular [img]="chevronDownIcon" [size]="16"></lucide-angular>
                    </button>

                    @if (showExportMenu()) {
                    <div
                        class="absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 z-10">
                        <button (click)="exportReport('excel')"
                            class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center space-x-2 rounded-t-lg">
                            <lucide-angular [img]="fileTextIcon" [size]="16" class="text-green-600"></lucide-angular>
                            <span class="text-gray-700 dark:text-gray-300">Excel Básico</span>
                        </button>
                        <button (click)="exportReport('pdf')"
                            class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center space-x-2">
                            <lucide-angular [img]="fileTextIcon" [size]="16" class="text-red-600"></lucide-angular>
                            <span class="text-gray-700 dark:text-gray-300">PDF</span>
                        </button>
                        <button (click)="exportReport('csv')"
                            class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center space-x-2 rounded-b-lg">
                            <lucide-angular [img]="fileTextIcon" [size]="16" class="text-gray-600"></lucide-angular>
                            <span class="text-gray-700 dark:text-gray-300">CSV</span>
                        </button>
                    </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6 mb-6 border border-gray-200 dark:border-gray-700">
        <form [formGroup]="filtersForm" (ngSubmit)="applyFilters()">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4">
                <div>
                    <label
                        class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 flex items-center space-x-1">
                        <lucide-angular [img]="calendarIcon" [size]="16"></lucide-angular>
                        <span>Fecha Inicio</span>
                        <lucide-angular [img]="infoIcon" [size]="14" (click)="ttStart.toggle($event)"></lucide-angular>
                    </label>
                    <app-tooltip-popover #ttStart text="Filtra desde esta fecha; puedes combinar con Año/Mes para periodo exacto."></app-tooltip-popover>
                    <input type="date" formControlName="startDate"
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white" />
                </div>

                <div>
                    <label
                        class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 flex items-center space-x-1">
                        <lucide-angular [img]="calendarIcon" [size]="16"></lucide-angular>
                        <span>Fecha Fin</span>
                        <lucide-angular [img]="infoIcon" [size]="14" (click)="ttEnd.toggle($event)"></lucide-angular>
                    </label>
                    <app-tooltip-popover #ttEnd text="Filtra hasta esta fecha; asegúrate que sea mayor o igual a la fecha inicio."></app-tooltip-popover>
                    <input type="date" formControlName="endDate"
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white" />
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 flex items-center gap-1">Año
                      <lucide-angular [img]="infoIcon" [size]="14" (click)="ttYear.toggle($event)"></lucide-angular>
                    </label>
                    <app-tooltip-popover #ttYear text="Selecciona el año del período de exportación."></app-tooltip-popover>
                    <select formControlName="year"
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
                        @for (y of [2024,2025,2026]; track y) {
                        <option [value]="y">{{ y }}</option>
                        }
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 flex items-center gap-1">Mes
                      <lucide-angular [img]="infoIcon" [size]="14" (click)="ttMonth.toggle($event)"></lucide-angular>
                    </label>
                    <app-tooltip-popover #ttMonth text="Selecciona el mes; el Excel mostrará el bloque con el nombre en español."></app-tooltip-popover>
                    <select formControlName="month"
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
                        @for (m of [1,2,3,4,5,6,7,8,9,10,11,12]; track m) {
                        <option [value]="m">{{ m }}</option>
                        }
                    </select>
                </div>

                <div>
                    <label
                        class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 flex items-center space-x-1">
                        <lucide-angular [img]="userIcon" [size]="16"></lucide-angular>
                        <span>Asesor</span>
                    </label>
                    <select formControlName="advisorId"
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
                        <option value="">Todos los asesores</option>
                        @for (advisor of advisors(); track advisor.employee_id) {
                        <option [value]="advisor.user_id">{{ advisor.first_name }} {{ advisor.last_name }}</option>
                        }
                    </select>
                </div>

                <div>
                    <label
                        class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 flex items-center space-x-1">
                        <lucide-angular [img]="buildingIcon" [size]="16"></lucide-angular>
                        <span>Oficina/Equipo</span>
                    </label>
                    <select formControlName="officeId"
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
                        <option value="">Todas las oficinas</option>
                        @for (office of offices(); track office.team_id) {
                        <option [value]="office.team_id">{{ office.team_name }}</option>
                        }
                    </select>
                </div>
            </div>

            <div class="flex gap-4 mt-4 justify-end">
                <button type="submit"
                    class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center space-x-2">
                    <lucide-angular [img]="filterIcon" [size]="16"></lucide-angular>
                    <span>Aplicar Filtros</span>
                </button>
                <button type="button" (click)="clearFilters()"
                    class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center space-x-2">
                    <lucide-angular [img]="xIcon" [size]="16"></lucide-angular>
                    <span>Limpiar</span>
                </button>
            </div>
        </form>
    </div>

    <!-- KPI Cards -->
    @if (dashboardData()) {
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div
            class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg p-6 text-white shadow-lg hover:shadow-xl transition-shadow">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm font-medium opacity-90">Total Ventas</h3>
                <lucide-angular [img]="trendingUpIcon" [size]="20" class="opacity-75"></lucide-angular>
            </div>
            <p class="text-3xl font-bold">{{ totalSales() }}</p>
            <p class="text-xs opacity-75 mt-1">Contratos cerrados</p>
        </div>

        <div
            class="bg-gradient-to-br from-green-500 to-green-600 rounded-lg p-6 text-white shadow-lg hover:shadow-xl transition-shadow">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm font-medium opacity-90">Ingresos Totales</h3>
                <lucide-angular [img]="dollarSignIcon" [size]="20" class="opacity-75"></lucide-angular>
            </div>
            <p class="text-3xl font-bold">${{ totalRevenue() | number:'1.0-0' }}</p>
            <p class="text-xs opacity-75 mt-1">Valor total de ventas</p>
        </div>

        <div
            class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg p-6 text-white shadow-lg hover:shadow-xl transition-shadow">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm font-medium opacity-90">Venta Promedio</h3>
                <lucide-angular [img]="barChartIcon" [size]="20" class="opacity-75"></lucide-angular>
            </div>
            <p class="text-3xl font-bold">${{ averageSale() | number:'1.0-0' }}</p>
            <p class="text-xs opacity-75 mt-1">Por contrato</p>
        </div>

        <div
            class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-lg p-6 text-white shadow-lg hover:shadow-xl transition-shadow">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm font-medium opacity-90">Crecimiento</h3>
                <lucide-angular [img]="trendingUpIcon" [size]="20" class="opacity-75"></lucide-angular>
            </div>
            <p class="text-3xl font-bold">{{ salesGrowth() | number:'1.1-1' }}%</p>
            <p class="text-xs opacity-75 mt-1">vs período anterior</p>
        </div>
    </div>
    }

    <!-- Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Advisor Performance Chart -->
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 shadow-sm border border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center space-x-2">
                <lucide-angular [img]="usersIcon" [size]="20"></lucide-angular>
                <span>Rendimiento por Asesor</span>
            </h3>
            @if (advisorChartData()) {
            <canvas baseChart [data]="advisorChartData()!" [options]="advisorChartOptions()"
                [type]="advisorChartType()">
            </canvas>
            } @else {
            <div class="flex items-center justify-center h-64 text-gray-400">
                <p>No hay datos disponibles</p>
            </div>
            }
        </div>

        <!-- Sales Trend Chart -->
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 shadow-sm border border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center space-x-2">
                <lucide-angular [img]="trendingUpIcon" [size]="20"></lucide-angular>
                <span>Tendencia de Ventas</span>
            </h3>
            @if (trendChartData()) {
            <canvas baseChart [data]="trendChartData()!" [options]="trendChartOptions()" [type]="trendChartType()">
            </canvas>
            } @else {
            <div class="flex items-center justify-center h-64 text-gray-400">
                <p>No hay datos disponibles</p>
            </div>
            }
        </div>
    </div>

    <!-- Loading State -->
    @if (isLoading()) {
    <div class="flex items-center justify-center py-12">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
    </div>
    }
</div>
