<ng-container *ngIf="user$ | async as u">
<div class="p-8 space-y-6 animate-fade-in">
    <!-- Encabezado mejorado con gradiente -->
    <div class="bg-gradient-to-r from-blue-600 to-purple-600 rounded-xl p-6 text-white shadow-lg gradient-animate hover-lift">
        <div class="flex justify-between items-center">
            <div class="flex items-center space-x-3 animate-slide-in-right">
                <div class="bg-white/20 p-3 rounded-lg animate-bounce-in">
                    <i class="fas fa-user-circle text-2xl text-glow"></i>
                </div>
                <div>
                    <h2 class="text-3xl font-bold text-glow">Detalle de Usuario</h2>
                    <p class="text-blue-100 mt-1">Información completa del usuario {{ u.first_name }} {{ u.last_name }}</p>
                </div>
            </div>
            <div class="flex gap-3 stagger-animation">
                <button 
                    routerLink="/security/users" 
                    class="bg-white/20 hover:bg-white/30 backdrop-blur-sm border border-white/30 text-white px-4 py-2 rounded-lg flex items-center gap-2 smooth-transition hover:scale-105 shadow-lg micro-bounce focus-ring">
                    <lucide-icon [name]="ArrowLeft" size="16" />
                    <span class="font-medium">Volver</span>
                </button>
                
                <button 
                    *ngIf="!isEditing" 
                    (click)="toggleEdit()" 
                    class="bg-white text-blue-600 hover:bg-blue-50 px-4 py-2 rounded-lg flex items-center gap-2 smooth-transition hover:scale-105 shadow-lg font-medium micro-bounce focus-ring animate-pulse-glow">
                    <lucide-icon [name]="Edit" size="16" />
                    <span>Editar</span>
                </button>
                
                <ng-container *ngIf="isEditing">
                    <button 
                        type="button"
                        (click)="saveChanges()" 
                        class="bg-green-500 hover:bg-green-400 text-white px-4 py-2 rounded-lg flex items-center gap-2 smooth-transition hover:scale-105 shadow-lg font-medium micro-bounce focus-ring">
                        <lucide-icon [name]="Save" size="16" />
                        <span>Guardar</span>
                    </button>
                    <button 
                        (click)="toggleEdit()" 
                        class="bg-gray-500 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-white px-4 py-2 rounded-lg flex items-center gap-2 smooth-transition hover:scale-105 shadow-lg font-medium micro-bounce focus-ring">
                        <lucide-icon [name]="X" size="16" />
                        <span>Cancelar</span>
                    </button>
                </ng-container>
                
                <button 
                    (click)="onDelete(u.id)" 
                    class="bg-red-500/80 hover:bg-red-500 text-white px-4 py-2 rounded-lg flex items-center gap-2 smooth-transition hover:scale-105 shadow-lg font-medium micro-bounce focus-ring">
                    <lucide-icon [name]="Trash2" size="16" />
                    <span>Eliminar</span>
                </button>
            </div>
        </div>
    </div>

    <!-- User Profile Section -->
    <div class="flex flex-col lg:flex-row gap-8 animate-fade-in">
        <!-- Photo Section -->
        <div class="flex-shrink-0">
            <div class="relative group">
                <div class="w-40 h-40 rounded-full border-4 border-gradient-to-r from-blue-500 to-purple-600 overflow-hidden mb-4 mx-auto lg:mx-0 shadow-xl hover-lift transition-all duration-300">
                    <img *ngIf="u.photo_url; else placeholder" [src]="backendBaseUrl + u.photo_url" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110" />
                    <ng-template #placeholder>
                        <div class="w-full h-full bg-gradient-to-br from-gray-700 to-gray-800 flex items-center justify-center text-gray-400 text-5xl">
                            <lucide-icon [name]="User" class="animate-pulse" />
                        </div>
                    </ng-template>
                </div>
                
                <!-- Photo upload in edit mode -->
                <div *ngIf="isEditing" class="text-center">
                    <input 
                        type="file" 
                        accept="image/*" 
                        (change)="onFileSelect($event, 'photo')" 
                        class="hidden" 
                        #photoInput>
                    <button 
                        (click)="photoInput.click()" 
                        class="inline-flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg hover:from-blue-600 hover:to-purple-700 transition-all duration-300 transform hover:scale-105 shadow-lg">
                        <lucide-icon [name]="Camera" class="w-4 h-4" />
                        <span class="text-sm font-medium">Cambiar Foto</span>
                    </button>
                    <p *ngIf="selectedFile" class="text-green-400 text-xs mt-2 font-medium">{{ selectedFile.name }}</p>
                </div>
            </div>
        </div>

        <!-- User Information -->
        <div class="flex-1">
            <!-- Basic Info -->
            <div class="mb-8">
                <h1 class="text-3xl font-bold mb-2">
                    <ng-container *ngIf="!isEditing">{{ u.first_name }} {{ u.last_name }}</ng-container>
                    <ng-container *ngIf="isEditing">
                        <div class="flex gap-2">
                            <input 
                                [formControl]="firstNameControl" 
                                class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded px-3 py-1 text-lg flex-1 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300"
                                placeholder="Nombre">
                            <input 
                                [formControl]="lastNameControl" 
                                class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded px-3 py-1 text-lg flex-1 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300"
                                placeholder="Apellido">
                        </div>
                    </ng-container>
                </h1>
                
                <div class="flex items-center gap-4 text-gray-300">
                    <span class="inline-block px-3 py-1 rounded-full text-sm font-medium" [ngClass]="{
                        'bg-green-600': u.status==='active',
                        'bg-red-600': u.status==='blocked'
                    }">{{ u.status | titlecase }}</span>
                    
                    <span *ngIf="u.position" class="text-blue-400">{{ u.position }}</span>
                    <span *ngIf="u.department" class="text-gray-400">{{ u.department }}</span>
                </div>
            </div>

            <!-- Form for editing or display -->
            <form [formGroup]="editForm" class="space-y-6">
                <!-- Contact Information -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg hover-lift transition-all duration-300 border border-gray-200 dark:border-gray-700">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="p-2 bg-gradient-to-r from-blue-500 to-cyan-500 rounded-lg">
                            <lucide-icon [name]="Mail" class="w-5 h-5 text-white" />
                        </div>
                        <h3 class="text-xl font-semibold text-gray-800 dark:text-white">Información de Contacto</h3>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Username -->
                        <div class="space-y-2">
                            <label class="flex items-center gap-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                                <lucide-icon [name]="User" class="w-4 h-4 text-blue-500" />
                                Usuario
                            </label>
                            <ng-container *ngIf="!isEditing">
                                <p class="text-gray-800 dark:text-gray-200 bg-gray-50 dark:bg-gray-700 p-3 rounded-lg">{{ u.username }}</p>
                            </ng-container>
                            <input 
                                *ngIf="isEditing"
                                formControlName="username" 
                                class="w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-3 text-gray-800 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300"
                                placeholder="Nombre de usuario">
                        </div>

                        <!-- Email -->
                        <div class="space-y-2">
                            <label class="flex items-center gap-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                                <lucide-icon [name]="Mail" class="w-4 h-4 text-green-500" />
                                Email
                            </label>
                            <ng-container *ngIf="!isEditing">
                                <p class="text-gray-800 dark:text-gray-200 bg-gray-50 dark:bg-gray-700 p-3 rounded-lg">{{ u.email }}</p>
                            </ng-container>
                            <input 
                                *ngIf="isEditing"
                                formControlName="email" 
                                type="email"
                                class="w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-3 text-gray-800 dark:text-white focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-300"
                                placeholder="Correo electrónico">
                        </div>

                        <!-- DNI -->
                        <div class="space-y-2">
                            <label class="flex items-center gap-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                                <lucide-icon [name]="CreditCard" class="w-4 h-4 text-purple-500" />
                                DNI
                            </label>
                            <ng-container *ngIf="!isEditing">
                                <p class="text-gray-800 dark:text-gray-200 bg-gray-50 dark:bg-gray-700 p-3 rounded-lg">{{ u.dni || '-' }}</p>
                            </ng-container>
                            <input 
                                *ngIf="isEditing"
                                formControlName="dni" 
                                class="w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-3 text-gray-800 dark:text-white focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-300"
                                placeholder="Documento de identidad">
                        </div>

                        <!-- Phone -->
                        <div class="space-y-2">
                            <label class="flex items-center gap-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                                <lucide-icon [name]="Phone" class="w-4 h-4 text-orange-500" />
                                Teléfono
                            </label>
                            <ng-container *ngIf="!isEditing">
                                <p class="text-gray-800 dark:text-gray-200 bg-gray-50 dark:bg-gray-700 p-3 rounded-lg">{{ u.phone || '-' }}</p>
                            </ng-container>
                            <input 
                                *ngIf="isEditing"
                                formControlName="phone" 
                                class="w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-3 text-gray-800 dark:text-white focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all duration-300"
                                placeholder="Número de teléfono">
                        </div>
                    </div>
                </div>

                <!-- Work Information -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg hover-lift transition-all duration-300 border border-gray-200 dark:border-gray-700">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="p-2 bg-gradient-to-r from-green-500 to-emerald-500 rounded-lg">
                            <lucide-icon [name]="Briefcase" class="w-5 h-5 text-white" />
                        </div>
                        <h3 class="text-xl font-semibold text-gray-800 dark:text-white">Información Laboral</h3>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Position -->
                        <div class="space-y-2">
                            <label class="flex items-center gap-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                                <lucide-icon [name]="Award" class="w-4 h-4 text-yellow-500" />
                                Cargo
                            </label>
                            <ng-container *ngIf="!isEditing">
                                <p class="text-gray-800 dark:text-gray-200 bg-gray-50 dark:bg-gray-700 p-3 rounded-lg">{{ u.position || '-' }}</p>
                            </ng-container>
                            <input 
                                *ngIf="isEditing"
                                formControlName="position" 
                                class="w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-3 text-gray-800 dark:text-white focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition-all duration-300"
                                placeholder="Cargo o posición">
                        </div>

                        <!-- Department -->
                        <div class="space-y-2">
                            <label class="flex items-center gap-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                                <lucide-icon [name]="Building" class="w-4 h-4 text-indigo-500" />
                                Departamento
                            </label>
                            <ng-container *ngIf="!isEditing">
                                <p class="text-gray-800 dark:text-gray-200 bg-gray-50 dark:bg-gray-700 p-3 rounded-lg">{{ u.department || '-' }}</p>
                            </ng-container>
                            <input 
                                *ngIf="isEditing"
                                formControlName="department" 
                                class="w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-3 text-gray-800 dark:text-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all duration-300"
                                placeholder="Departamento">
                        </div>

                        <!-- Birth Date -->
                        <div class="space-y-2">
                            <label class="flex items-center gap-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                                <lucide-icon [name]="Calendar" class="w-4 h-4 text-pink-500" />
                                Fecha de Nacimiento
                            </label>
                            <ng-container *ngIf="!isEditing">
                                <p class="text-gray-800 dark:text-gray-200 bg-gray-50 dark:bg-gray-700 p-3 rounded-lg">{{ u.birth_date ? (u.birth_date | date:'longDate') : '-' }}</p>
                            </ng-container>
                            <input 
                                *ngIf="isEditing"
                                formControlName="birth_date" 
                                type="date"
                                class="w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-3 text-gray-800 dark:text-white focus:ring-2 focus:ring-pink-500 focus:border-transparent transition-all duration-300">
                        </div>

                        <!-- Hire Date -->
                        <div class="space-y-2">
                            <label class="flex items-center gap-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                                <lucide-icon [name]="CalendarCheck" class="w-4 h-4 text-teal-500" />
                                Fecha de Contratación
                            </label>
                            <ng-container *ngIf="!isEditing">
                                <p class="text-gray-800 dark:text-gray-200 bg-gray-50 dark:bg-gray-700 p-3 rounded-lg">{{ u.hire_date ? (u.hire_date | date:'longDate') : '-' }}</p>
                            </ng-container>
                            <input 
                                *ngIf="isEditing"
                                formControlName="hire_date" 
                                type="date"
                                class="w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-3 text-gray-800 dark:text-white focus:ring-2 focus:ring-teal-500 focus:border-transparent transition-all duration-300">
                        </div>

                        <!-- Status -->
                        <div *ngIf="isEditing" class="space-y-2">
                            <label class="flex items-center gap-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                                <lucide-icon [name]="Shield" class="w-4 h-4 text-red-500" />
                                Estado
                            </label>
                            <select 
                                formControlName="status" 
                                class="w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-3 text-gray-800 dark:text-white focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all duration-300">
                                <option value="active">Activo</option>
                                <option value="blocked">Bloqueado</option>
                            </select>
                        </div>

                        <!-- CV -->
                        <div class="space-y-2">
                            <label class="flex items-center gap-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                                <lucide-icon [name]="FileText" class="w-4 h-4 text-cyan-500" />
                                Currículum Vitae
                            </label>
                            <ng-container *ngIf="!isEditing">
                                <ng-container *ngIf="u.cv_url; else noCv">
                                    <a [href]="backendBaseUrl + u.cv_url" target="_blank" class="inline-flex items-center gap-2 text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 text-sm font-medium transition-colors duration-300">
                                        <lucide-icon [name]="Download" class="w-4 h-4" />
                                        Descargar CV
                                    </a>
                                </ng-container>
                                <ng-template #noCv>
                                    <p class="text-gray-800 dark:text-gray-200 bg-gray-50 dark:bg-gray-700 p-3 rounded-lg">-</p>
                                </ng-template>
                            </ng-container>
                            
                            <div *ngIf="isEditing">
                                <input 
                                    type="file" 
                                    accept=".pdf,.doc,.docx" 
                                    (change)="onFileSelect($event, 'cv')" 
                                    class="hidden" 
                                    #cvInput>
                                <button 
                                    type="button"
                                    (click)="cvInput.click()" 
                                    class="inline-flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-cyan-500 to-blue-500 text-white rounded-lg hover:from-cyan-600 hover:to-blue-600 transition-all duration-300 transform hover:scale-105 shadow-lg">
                                    <lucide-icon [name]="Upload" class="w-4 h-4" />
                                    <span class="text-sm font-medium">Subir CV</span>
                                </button>
                                <p *ngIf="selectedCvFile" class="text-green-600 dark:text-green-400 text-xs mt-2 font-medium">{{ selectedCvFile.name }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Roles and Permissions -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg hover-lift transition-all duration-300 border border-gray-200 dark:border-gray-700">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="p-2 bg-gradient-to-r from-purple-500 to-pink-500 rounded-lg">
                            <lucide-icon [name]="Shield" class="w-5 h-5 text-white" />
                        </div>
                        <h3 class="text-xl font-semibold text-gray-800 dark:text-white">Roles y Permisos</h3>
                    </div>
                    
                    <!-- Roles -->
                    <div class="mb-6">
                        <label class="flex items-center gap-2 text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">
                            <lucide-icon [name]="Users" class="w-4 h-4 text-purple-500" />
                            Roles
                        </label>
                        <ng-container *ngIf="!isEditing">
                            <div class="flex flex-wrap gap-2">
                                <span *ngFor="let role of u.roles" class="inline-flex items-center gap-2 bg-purple-100 dark:bg-purple-800 text-purple-800 dark:text-purple-100 border border-purple-200 dark:border-purple-700 px-4 py-2 rounded-full text-sm font-medium shadow-sm hover:bg-purple-200 dark:hover:bg-purple-700 transition-colors duration-200">
                                    <lucide-icon [name]="Crown" class="w-3 h-3" />
                                    {{ role }}
                                </span>
                                <span *ngIf="!u.roles?.length" class="text-gray-500 dark:text-gray-400 italic">No hay roles asignados</span>
                            </div>
                        </ng-container>
                        
                        <div *ngIf="isEditing" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                            <label *ngFor="let role of roles" class="flex items-center space-x-3 cursor-pointer p-3 bg-gray-50 dark:bg-gray-700 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors duration-300">
                                <!-- Debug info -->
                                <div class="text-xs text-red-500 mb-1">
                                    Debug: role.role_id = {{ role.role_id }} ({{ typeof role.role_id }})
                                </div>
                                <input 
                                    type="radio" 
                                    name="roles"
                                    [value]="role.name"
                                    [checked]="isRoleSelected(role.role_id)"
                                    (change)="onRoleChange($event, role.name)"
                                    class="w-4 h-4 text-purple-600 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 focus:ring-purple-500 dark:focus:ring-purple-600 dark:ring-offset-gray-800 focus:ring-2">
                                <span class="text-sm font-medium text-gray-800 dark:text-gray-200">{{ role.name }}</span>
                            </label>
                        </div>
                    </div>

                    <!-- Permissions (read-only) -->
                    <div>
                        <label class="flex items-center gap-2 text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">
                            <lucide-icon [name]="Key" class="w-4 h-4 text-orange-500" />
                            Permisos
                        </label>
                        <div class="max-h-40 overflow-auto bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-lg p-4">
                            <div class="flex flex-wrap gap-2">
                                <span *ngFor="let permission of u.permissions" class="inline-flex items-center gap-1 bg-orange-100 dark:bg-orange-800 text-orange-800 dark:text-orange-100 border border-orange-200 dark:border-orange-700 px-3 py-1 text-xs rounded-full font-medium shadow-sm hover:bg-orange-200 dark:hover:bg-orange-700 transition-colors duration-200">
                                    <lucide-icon [name]="Lock" class="w-3 h-3" />
                                    {{ permission }}
                                </span>
                                <span *ngIf="!u.permissions?.length" class="text-gray-500 dark:text-gray-400 italic">No hay permisos asignados</span>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
</ng-container>