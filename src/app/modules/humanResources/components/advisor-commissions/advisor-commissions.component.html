<div class="advisor-commissions-container max-w-7xl mx-auto p-4 sm:p-6 bg-gray-50 dark:bg-gray-900 min-h-screen">
  <!-- Header -->
  <div class="header bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 mb-6 sm:mb-8">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
      <div class="flex items-center gap-3 sm:gap-4">
        <button 
          type="button"
          (click)="goBack()"
          class="btn-back bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 p-2 rounded-lg transition-colors duration-200 flex-shrink-0">
          <lucide-angular [img]="ArrowLeft" size="20"></lucide-angular>
        </button>
        <div class="min-w-0">
          <h1 class="text-2xl sm:text-3xl lg:text-4xl font-bold text-gray-900 dark:text-white border-l-4 border-blue-500 pl-4 truncate">
            Comisiones de {{ employeeName() }}
          </h1>
          <p class="subtitle text-gray-600 dark:text-gray-300 text-sm sm:text-base lg:text-lg">
            {{ monthName() }} {{ selectedYear() }} - {{ commissions().length }} comisión{{ commissions().length !== 1 ? 'es' : '' }}
          </p>
        </div>
      </div>
      
      <div class="header-actions flex gap-2 sm:gap-3">
        <button 
          *ngIf="hasPendingCommissions()"
          (click)="payAllPendingCommissions()"
          class="btn btn-success bg-green-600 hover:bg-green-700 text-white px-3 sm:px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center gap-2 text-sm sm:text-base">
          <lucide-angular [img]="CheckCircle" size="16"></lucide-angular>
          <span class="hidden sm:inline">Pagar Todas las Pendientes</span>
          <span class="sm:hidden">Pagar Todas</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Summary Cards -->
  <div class="summary-grid grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mb-6 sm:mb-8">
    <div class="summary-card bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700">
      <div class="flex items-center gap-3 sm:gap-4">
        <div class="icon bg-blue-100 text-blue-600 w-10 h-10 sm:w-12 sm:h-12 rounded-xl flex items-center justify-center">
          <lucide-angular [img]="DollarSign" [size]="20"></lucide-angular>
        </div>
        <div class="content flex-1">
          <h3 class="value text-lg sm:text-2xl font-bold text-gray-900 dark:text-gray-100">{{ formatCurrency(totalAmount()) }}</h3>
          <p class="label text-xs sm:text-sm text-gray-600 dark:text-gray-300">Total Comisiones</p>
        </div>
      </div>
    </div>
    
    <div class="summary-card bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700">
      <div class="flex items-center gap-3 sm:gap-4">
        <div class="icon bg-green-100 text-green-600 w-10 h-10 sm:w-12 sm:h-12 rounded-xl flex items-center justify-center">
          <lucide-angular [img]="CheckCircle" [size]="20"></lucide-angular>
        </div>
        <div class="content flex-1">
          <h3 class="value text-lg sm:text-2xl font-bold text-gray-900 dark:text-gray-100">{{ formatCurrency(paidAmount()) }}</h3>
          <p class="label text-xs sm:text-sm text-gray-600 dark:text-gray-300">Pagadas ({{ paidCount() }})</p>
        </div>
      </div>
    </div>
    
    <div class="summary-card bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700">
      <div class="flex items-center gap-3 sm:gap-4">
        <div class="icon bg-yellow-100 text-yellow-600 w-10 h-10 sm:w-12 sm:h-12 rounded-xl flex items-center justify-center">
          <lucide-angular [img]="Clock" [size]="20"></lucide-angular>
        </div>
        <div class="content flex-1">
          <h3 class="value text-lg sm:text-2xl font-bold text-gray-900 dark:text-gray-100">{{ formatCurrency(pendingAmount()) }}</h3>
          <p class="label text-xs sm:text-sm text-gray-600 dark:text-gray-300">Pendientes ({{ pendingCount() }})</p>
        </div>
      </div>
    </div>
    
    <div class="summary-card bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700">
      <div class="flex items-center gap-3 sm:gap-4">
        <div class="icon bg-purple-100 text-purple-600 w-10 h-10 sm:w-12 sm:h-12 rounded-xl flex items-center justify-center">
          <lucide-angular [img]="TrendingUp" [size]="20"></lucide-angular>
        </div>
        <div class="content flex-1">
          <h3 class="value text-lg sm:text-2xl font-bold text-gray-900 dark:text-gray-100">{{ paymentPercentage() }}%</h3>
          <p class="label text-xs sm:text-sm text-gray-600 dark:text-gray-300">Progreso de Pago</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading()" class="loading-state bg-white dark:bg-gray-800 p-12 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 flex flex-col items-center justify-center">
    <div class="loading-spinner w-10 h-10 border-4 border-gray-200 border-t-blue-600 rounded-full animate-spin mb-4"></div>
    <p class="text-gray-600 dark:text-gray-300">Cargando comisiones...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error()" class="error-state bg-white dark:bg-gray-800 p-12 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 flex flex-col items-center justify-center text-center">
    <div class="error-icon text-red-500 mb-4">
      <lucide-angular [img]="XCircle" size="48"></lucide-angular>
    </div>
    <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-2">Error al cargar datos</h3>
    <p class="text-gray-600 dark:text-gray-300 mb-6">{{ error() }}</p>
    <button class="btn btn-primary bg-blue-600 hover:bg-blue-700 text-white px-6 py-2.5 rounded-lg font-medium transition-all duration-200 hover:shadow-lg hover:shadow-blue-500/25" (click)="loadCommissions()">
      Reintentar
    </button>
  </div>

  <!-- Commissions List -->
  <div *ngIf="!loading() && !error()" class="commissions-list space-y-4 sm:space-y-6">
    <div *ngFor="let commission of commissions(); trackBy: trackByCommissionId" 
         class="commission-card bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 hover:shadow-md transition-all duration-200">
      
      <!-- Card Header -->
      <div class="card-header p-4 sm:p-6 border-b border-gray-100 dark:border-gray-700">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
          <div class="commission-info flex-1">
            <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4">
              <h3 class="commission-title text-lg font-semibold text-gray-900 dark:text-gray-100">
                Comisión #{{ commission.commission_id }}
              </h3>
              <span [class]="'commission-type-indicator text-sm px-2 py-1 rounded-full w-fit font-medium ' + getCommissionTypeClass(commission)">
                {{ getCommissionHierarchyLabel(commission) }}
              </span>
              <span class="commission-type text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded-full w-fit">
                {{ getCommissionTypeLabel(commission.commission_type) }}
              </span>
              <span *ngIf="commission.notes" class="payment-info text-sm bg-orange-100 text-orange-800 px-2 py-1 rounded-full w-fit">
                {{ commission.notes }}
              </span>
            </div>
          </div>
          <div class="commission-status">
            <span [class]="'status-badge inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-medium ' + getStatusClass(commission.payment_status)">
              <lucide-angular [img]="getStatusIcon(commission.payment_status)" size="14"></lucide-angular>
              {{ getStatusLabel(commission.payment_status) }}
            </span>
          </div>
        </div>
      </div>

      <!-- Card Body -->
      <div class="card-body p-4 sm:p-6">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
          <!-- Commission Amount -->
          <div class="info-item">
            <label class="info-label text-xs sm:text-sm font-medium text-gray-600 dark:text-gray-300 mb-1 block">Monto de Comisión</label>
            <p class="info-value text-lg sm:text-xl font-bold text-green-600">{{ formatCurrency(commission.commission_amount) }}</p>
          </div>
          
          <!-- Sale Amount -->
          <div class="info-item" *ngIf="commission.sale_amount">
            <label class="info-label text-xs sm:text-sm font-medium text-gray-600 dark:text-gray-300 mb-1 block">Monto de Venta</label>
            <p class="info-value text-sm sm:text-base text-gray-900 dark:text-gray-100 font-medium">{{ formatCurrency(commission.sale_amount) }}</p>
          </div>
          
          <!-- Commission Percentage -->
          <div class="info-item" *ngIf="commission.commission_percentage">
            <label class="info-label text-xs sm:text-sm font-medium text-gray-600 dark:text-gray-300 mb-1 block">Porcentaje</label>
            <p class="info-value text-sm sm:text-base text-gray-900 dark:text-gray-100 font-medium">{{ commission.commission_percentage }}%</p>
          </div>
          
          <!-- Contract ID -->
          <div class="info-item" *ngIf="commission.contract_id">
            <label class="info-label text-xs sm:text-sm font-medium text-gray-600 dark:text-gray-300 mb-1 block">ID del Contrato</label>
            <p class="info-value text-sm font-mono bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded text-gray-900 dark:text-gray-100">{{ commission.contract_id }}</p>
          </div>
          
          <!-- Installment Plan -->
          <div class="info-item" *ngIf="commission.installment_plan">
            <label class="info-label text-xs sm:text-sm font-medium text-gray-600 dark:text-gray-300 mb-1 block">Plan de Cuotas</label>
            <p class="info-value text-sm sm:text-base text-gray-900 dark:text-gray-100 font-medium">{{ commission.installment_plan }} meses</p>
          </div>
          
          <!-- Payment Date -->
          <div class="info-item" *ngIf="commission.payment_date">
            <label class="info-label text-xs sm:text-sm font-medium text-gray-600 dark:text-gray-300 mb-1 block">Fecha de Pago</label>
            <p class="info-value text-sm sm:text-base text-gray-900 dark:text-gray-100 font-medium">{{ formatDate(commission.payment_date) }}</p>
          </div>
        </div>
      </div>

      <!-- Child Commissions (Divisiones de Pago) -->
      <div *ngIf="commission.child_commissions && commission.child_commissions.length > 0" class="child-commissions border-t border-gray-100 dark:border-gray-700">
        <div class="p-4 sm:p-6">
          <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-4 flex items-center gap-2">
            <lucide-angular [img]="Split" size="16"></lucide-angular>
            Divisiones de Pago ({{ commission.child_commissions.length }})
          </h4>
          <div class="space-y-3">
            <div *ngFor="let childCommission of commission.child_commissions; trackBy: trackByCommissionId" 
                 class="child-commission bg-purple-50 dark:bg-purple-900/20 border border-purple-200 dark:border-purple-700 rounded-lg p-4">
              
              <!-- Child Commission Header -->
              <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-3">
                <div class="child-info flex-1">
                  <div class="flex flex-col sm:flex-row sm:items-center gap-2">
                    <h5 class="text-sm font-semibold text-purple-900 dark:text-purple-100">
                      División #{{ childCommission.commission_id }}
                    </h5>
                    <span class="text-xs bg-purple-100 text-purple-800 dark:bg-purple-800 dark:text-purple-200 px-2 py-1 rounded-full w-fit">
                      {{ getCommissionHierarchyLabel(childCommission) }}
                    </span>
                    <span *ngIf="childCommission.notes" class="text-xs bg-orange-100 text-orange-800 px-2 py-1 rounded-full w-fit">
                      {{ childCommission.notes }}
                    </span>
                  </div>
                </div>
                <div class="child-status">
                  <span [class]="'status-badge inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium ' + getStatusClass(childCommission.payment_status)">
                    <lucide-angular [img]="getStatusIcon(childCommission.payment_status)" size="12"></lucide-angular>
                    {{ getStatusLabel(childCommission.payment_status) }}
                  </span>
                </div>
              </div>

              <!-- Child Commission Details -->
              <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                <div class="child-info-item">
                  <label class="text-xs font-medium text-purple-600 dark:text-purple-300 mb-1 block">Monto División</label>
                  <p class="text-sm font-bold text-purple-800 dark:text-purple-200">{{ formatCurrency(childCommission.commission_amount) }}</p>
                </div>
                
                <div class="child-info-item" *ngIf="childCommission.payment_part">
                  <label class="text-xs font-medium text-purple-600 dark:text-purple-300 mb-1 block">Parte de Pago</label>
                  <p class="text-sm text-purple-700 dark:text-purple-300">{{ childCommission.payment_part }}</p>
                </div>
                
                <div class="child-info-item" *ngIf="childCommission.payment_date">
                  <label class="text-xs font-medium text-purple-600 dark:text-purple-300 mb-1 block">Fecha de Pago</label>
                  <p class="text-sm text-purple-700 dark:text-purple-300">{{ formatDate(childCommission.payment_date) }}</p>
                </div>
              </div>

              <!-- Child Commission Actions -->
              <div class="flex items-center justify-end gap-2 mt-3 pt-3 border-t border-purple-200 dark:border-purple-700">
                <button
                  class="btn-icon btn-icon-primary w-7 h-7 rounded-md bg-blue-50 text-blue-600 hover:bg-blue-100 transition-all duration-200 flex items-center justify-center"
                  (click)="viewCommissionDetail(childCommission)"
                  title="Ver detalle">
                  <lucide-angular [img]="Eye" size="12"></lucide-angular>
                </button>
                <button
                  *ngIf="canEditCommission(childCommission)"
                  class="btn-icon btn-icon-warning w-7 h-7 rounded-md bg-yellow-50 text-yellow-600 hover:bg-yellow-100 transition-all duration-200 flex items-center justify-center"
                  (click)="editCommission(childCommission)"
                  title="Editar">
                  <lucide-angular [img]="Edit" size="12"></lucide-angular>
                </button>
                <button
                  *ngIf="canPayCommission(childCommission)"
                  class="btn-icon btn-icon-success w-7 h-7 rounded-md bg-green-50 text-green-600 hover:bg-green-100 transition-all duration-200 flex items-center justify-center"
                  (click)="payCommission(childCommission)"
                  title="Marcar como pagada">
                  <lucide-angular [img]="CheckCircle" size="12"></lucide-angular>
                </button>
                <button
                  *ngIf="canDeleteCommission(childCommission)"
                  class="btn-icon btn-icon-danger w-7 h-7 rounded-md bg-red-50 text-red-600 hover:bg-red-100 transition-all duration-200 flex items-center justify-center"
                  (click)="deleteCommission(childCommission)"
                  title="Eliminar">
                  <lucide-angular [img]="Trash2" size="12"></lucide-angular>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Card Footer -->
      <div class="card-footer p-4 sm:p-6 bg-gray-50 dark:bg-gray-700 rounded-b-xl">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
          <div class="commission-dates text-xs sm:text-sm text-gray-500 dark:text-gray-400">
            <span>Creada: {{ formatDate(commission.created_at) }}</span>
            <span class="mx-2">•</span>
            <span>Actualizada: {{ formatDate(commission.updated_at) }}</span>
          </div>
          <div class="action-buttons flex items-center gap-2">
            <button
              class="btn-icon btn-icon-primary w-8 h-8 rounded-lg bg-blue-50 text-blue-600 hover:bg-blue-100 hover:scale-110 transition-all duration-200 flex items-center justify-center"
              (click)="viewCommissionDetail(commission)"
              title="Ver detalle completo">
              <lucide-angular [img]="Eye" size="14"></lucide-angular>
            </button>
            <button
              *ngIf="canEditCommission(commission)"
              class="btn-icon btn-icon-warning w-8 h-8 rounded-lg bg-yellow-50 text-yellow-600 hover:bg-yellow-100 hover:scale-110 transition-all duration-200 flex items-center justify-center"
              (click)="editCommission(commission)"
              title="Editar">
              <lucide-angular [img]="Edit" size="14"></lucide-angular>
            </button>
            <button
              *ngIf="canCreateSplitPayment(commission)"
              class="btn-icon btn-icon-purple w-8 h-8 rounded-lg bg-purple-50 text-purple-600 hover:bg-purple-100 hover:scale-110 transition-all duration-200 flex items-center justify-center"
              (click)="createSplitPayment(commission)"
              title="Crear Pago Dividido">
              <lucide-angular [img]="Split" size="14"></lucide-angular>
            </button>
            <button
              *ngIf="canPayCommission(commission)"
              class="btn-icon btn-icon-success w-8 h-8 rounded-lg bg-green-50 text-green-600 hover:bg-green-100 hover:scale-110 transition-all duration-200 flex items-center justify-center"
              (click)="payCommission(commission)"
              title="Marcar como pagada">
              <lucide-angular [img]="CheckCircle" size="14"></lucide-angular>
            </button>
            <button
              *ngIf="canDeleteCommission(commission)"
              class="btn-icon btn-icon-danger w-8 h-8 rounded-lg bg-red-50 text-red-600 hover:bg-red-100 hover:scale-110 transition-all duration-200 flex items-center justify-center"
              (click)="deleteCommission(commission)"
              title="Eliminar">
              <lucide-angular [img]="Trash2" size="14"></lucide-angular>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Empty State -->
    <div *ngIf="commissions().length === 0" class="empty-state bg-white dark:bg-gray-800 p-12 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 flex flex-col items-center justify-center text-center">
      <div class="empty-icon text-gray-300 mb-4">
        <lucide-angular [img]="DollarSign" size="48"></lucide-angular>
      </div>
      <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-2">No hay comisiones</h3>
      <p class="text-gray-600 dark:text-gray-300">No se encontraron comisiones para este asesor en el período seleccionado.</p>
    </div>
  </div>
</div>