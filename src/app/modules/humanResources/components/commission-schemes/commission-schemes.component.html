<div class="commission-schemes-container">
  <div class="content-wrapper">
    <!-- Card: Esquemas de Comisión -->
    <div class="card card-primary">
      <div class="card-header">
        <h2 class="card-title">
          <svg class="icon-title" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
          Esquemas de Comisión
        </h2>
        <button (click)="openCreate()" class="btn btn-primary">
          <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
          </svg>
          Nuevo Esquema
        </button>
      </div>

      <!-- Error Message -->
      <div *ngIf="error" class="alert alert-error">{{ error }}</div>

      <!-- Loading State -->
      <div *ngIf="isLoading" class="loading-state">Cargando...</div>

      <!-- Schemes Table -->
      <div *ngIf="!isLoading" class="table-container">
        <table class="data-table">
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Vigencia</th>
              <th>Default</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let s of schemes" class="table-row">
              <td class="font-semibold">{{ s.name }}</td>
              <td>{{ s.effective_from || '-' }} — {{ s.effective_to || '-' }}</td>
              <td>
                <span [ngClass]="s.is_default ? 'badge badge-success' : 'badge badge-default'">
                  {{ s.is_default ? 'Sí' : 'No' }}
                </span>
              </td>
              <td class="action-buttons">
                <button (click)="edit(s)" class="btn btn-warning btn-sm">
                  <svg class="btn-icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536M9 13h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                  </svg>
                  Editar
                </button>
                <button (click)="remove(s)" class="btn btn-danger btn-sm">
                  <svg class="btn-icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                  </svg>
                  Eliminar
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Card: Reglas (global) -->
    <div class="card card-secondary">
      <div class="card-header-with-info">
        <h3 class="card-title-sm">
          <svg class="icon-title-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
          Reglas (global)
          <button type="button" class="info-button" (click)="rulesHelpPop.toggle($event)" aria-haspopup="dialog" aria-controls="rulesHelpPop">ℹ️</button>
        </h3>
        <app-tooltip-popover #rulesHelpPop [text]="'Prioridad: valores Term min/max > ventana de vigencia (Desde/Hasta) > Term group (legacy). Las reglas solo aplican si la venta cae dentro de la ventana de vigencia.'"></app-tooltip-popover>
        <button (click)="openRuleForm()" class="btn btn-success">
          <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
          </svg>
          Nueva Regla
        </button>
      </div>

      <!-- Rules Table -->
      <div class="table-container">
        <table class="data-table data-table-rules">
          <thead>
            <tr>
              <th>Scheme</th>
              <th>Ventas min</th>
              <th>Ventas max</th>
              <th>Term min (meses)</th>
              <th>Term max (meses)</th>
              <th>Desde</th>
              <th>Hasta</th>
              <th>Term group</th>
              <th>Tipo venta</th>
              <th>%</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let r of rules" class="table-row">
              <td>{{ getSchemeName(r.scheme_id) }}</td>
              <td>{{ r.min_sales }}</td>
              <td>{{ r.max_sales || '-' }}</td>
              <td>{{ r.term_min_months ?? '-' }}</td>
              <td>{{ r.term_max_months ?? '-' }}</td>
              <td>{{ r.effective_from || '-' }}</td>
              <td>{{ r.effective_to || '-' }}</td>
              <td>{{ r.term_group }}</td>
              <td>{{ r.sale_type || 'both' }}</td>
              <td>{{ r.percentage }}%</td>
              <td class="action-buttons">
                <button (click)="editRule(r)" class="btn btn-warning btn-sm">
                  <svg class="btn-icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536M9 13h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                  </svg>
                  Editar
                </button>
                <button (click)="deleteRule(r)" class="btn btn-danger btn-sm">
                  <svg class="btn-icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                  </svg>
                  Eliminar
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal: Scheme Create/Edit -->
  <div *ngIf="showForm" class="modal-backdrop" (click)="closeForm()">
    <div class="modal-container">
      <div id="schemeModal" class="modal" (click)="$event.stopPropagation()" tabindex="-1" role="dialog" aria-modal="true" aria-labelledby="schemeModalTitle" (keydown)="handleKeydown($event)">
        <!-- Modal Header -->
        <div class="modal-header modal-header-primary">
          <div class="modal-header-content">
            <div class="modal-icon-wrapper">
              <svg class="modal-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
            </div>
            <div>
              <h3 id="schemeModalTitle" class="modal-title">{{ editing ? 'Editar' : 'Crear' }} Esquema</h3>
              <p class="modal-subtitle">Detalles y ventana de vigencia del esquema</p>
            </div>
          </div>
          <button aria-label="Cerrar" (click)="closeForm()" class="modal-close-btn">
            <svg class="modal-close-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>

        <!-- Modal Body -->
        <div class="modal-body">
          <form [formGroup]="form" (ngSubmit)="save()" class="form">
            <div class="form-group">
              <label class="form-label">Nombre</label>
              <input formControlName="name" class="form-input" />
            </div>
            
            <div class="form-group">
              <label class="form-label">Descripción</label>
              <textarea formControlName="description" class="form-textarea"></textarea>
            </div>
            
            <div class="form-row">
              <div class="form-group flex-1">
                <label class="form-label">Desde</label>
                <input type="date" formControlName="effective_from" class="form-input" />
              </div>
              <div class="form-group flex-1">
                <label class="form-label">Hasta</label>
                <input type="date" formControlName="effective_to" class="form-input" />
              </div>
              <div class="form-group-checkbox">
                <label class="form-label">Default</label>
                <input type="checkbox" formControlName="is_default" class="form-checkbox" />
              </div>
            </div>
            
            <div class="form-actions">
              <button type="button" (click)="closeForm()" class="btn btn-secondary">Cancelar</button>
              <button type="submit" [disabled]="form.invalid" class="btn btn-primary">Guardar</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Rule Create/Edit -->
  <div *ngIf="showRuleFormFlag" class="modal-backdrop" (click)="closeRuleForm()">
    <div class="modal-container">
      <div id="ruleModal" class="modal modal-lg" (click)="$event.stopPropagation()" tabindex="-1" role="dialog" aria-modal="true" aria-labelledby="ruleModalTitle" (keydown)="handleKeydown($event)">
        <!-- Modal Header -->
        <div class="modal-header modal-header-secondary">
          <div>
            <h3 id="ruleModalTitle" class="modal-title">{{ editingRule ? 'Editar' : 'Crear' }} Regla</h3>
            <p class="modal-subtitle">Define la regla que aplicará para ventas según rango, plazo y tipo de venta.</p>
          </div>
          <button aria-label="Cerrar" (click)="closeRuleForm()" class="modal-close-btn">
            <svg xmlns="http://www.w3.org/2000/svg" class="modal-close-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>

        <!-- Modal Body -->
        <div class="modal-body">
          <form [formGroup]="ruleForm" (ngSubmit)="saveRule()" class="form">
            <div class="form-grid">
              <div class="form-group">
                <label class="form-label">Scheme</label>
                <div class="select-wrapper">
                  <select formControlName="scheme_id" class="form-select">
                    <option *ngFor="let s of schemes" [value]="s.id">{{ s.name }}</option>
                  </select>
                  <span class="select-arrow">
                    <svg class="select-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                  </span>
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">Tipo de venta</label>
                <div class="select-wrapper">
                  <select formControlName="sale_type" class="form-select">
                    <option value="both">Ambas</option>
                    <option value="cash">Contado</option>
                    <option value="financed">Financiada</option>
                  </select>
                  <span class="select-arrow">
                    <svg class="select-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                  </span>
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">Ventas min</label>
                <input type="number" formControlName="min_sales" placeholder="Mínimo" class="form-input" />
              </div>

              <div class="form-group">
                <label class="form-label">Ventas max</label>
                <input type="number" formControlName="max_sales" placeholder="Máximo" class="form-input" />
              </div>

              <div class="form-group-full">
                <div class="form-subgrid">
                  <div class="form-group">
                    <label class="form-label">Term min (meses)</label>
                    <input type="number" placeholder="Min" formControlName="term_min_months" class="form-input" />
                  </div>
                  <div class="form-group">
                    <label class="form-label">Term max (meses)</label>
                    <input type="number" placeholder="Max" formControlName="term_max_months" class="form-input" />
                  </div>
                </div>
                
                <div class="form-subgrid">
                  <div class="form-group">
                    <label class="form-label">Desde</label>
                    <input type="date" formControlName="effective_from" placeholder="Desde" class="form-input" />
                  </div>
                  <div class="form-group">
                    <label class="form-label">Hasta</label>
                    <input type="date" formControlName="effective_to" placeholder="Hasta" class="form-input" />
                  </div>
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">Term group</label>
                <div class="select-wrapper">
                  <select formControlName="term_group" class="form-select">
                    <option value="short">Corto</option>
                    <option value="long">Largo</option>
                    <option value="any">Cualquiera</option>
                  </select>
                  <span class="select-arrow">
                    <svg class="select-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                  </span>
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">Porcentaje</label>
                <div class="input-group">
                  <input type="number" step="0.01" formControlName="percentage" placeholder="%" class="form-input input-group-field" />
                  <span class="input-group-addon">%</span>
                </div>
              </div>

              <div class="form-group-full">
                <label class="form-label">Prioridad</label>
                <input type="number" formControlName="priority" placeholder="Prioridad" class="form-input" />
              </div>
            </div>

            <div class="form-actions">
              <button type="button" (click)="closeRuleForm()" class="btn btn-secondary">Cancelar</button>
              <button type="submit" [disabled]="ruleForm.invalid" class="btn btn-primary" [attr.aria-disabled]="ruleForm.invalid ? 'true' : 'false'">Guardar</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
