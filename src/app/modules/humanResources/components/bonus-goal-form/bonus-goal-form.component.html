<div class="relative min-h-screen bg-gradient-to-br from-slate-50 via-blue-50/30 to-indigo-50 dark:from-gray-950 dark:via-blue-900/20 dark:to-indigo-900/30 overflow-hidden">
  <!-- soft blobs -->
  <div class="pointer-events-none absolute inset-0 bg-[radial-gradient(circle_at_15%_10%,rgba(59,130,246,0.10),transparent_55%)] dark:bg-[radial-gradient(circle_at_15%_10%,rgba(59,130,246,0.06),transparent_55%)]"></div>
  <div class="pointer-events-none absolute inset-0 bg-[radial-gradient(circle_at_90%_85%,rgba(168,85,247,0.10),transparent_55%)] dark:bg-[radial-gradient(circle_at_90%_85%,rgba(168,85,247,0.05),transparent_55%)]"></div>

  <div class="bonus-goal-form-container relative max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
    <!-- Header -->
    <div
      class="header bg-white/70 dark:bg-gray-800/70 backdrop-blur-xl p-6 rounded-2xl shadow-xl border border-white/20 dark:border-gray-700/50 mb-8">
      <button
        class="back-button inline-flex items-center gap-2 text-gray-700 dark:text-gray-300 hover:text-blue-600 font-medium mb-4 transition-all duration-200 hover:bg-blue-50 dark:hover:bg-blue-900/20 px-4 py-2 rounded-lg"
        (click)="onCancel()">
        <lucide-icon [img]="ArrowLeft" size="20"></lucide-icon>
        Volver a Metas de Bonos
      </button>
      <div class="header-content">
        <h1
          class="title flex items-center gap-4 text-3xl sm:text-4xl font-extrabold bg-gradient-to-r from-gray-900 via-blue-800 to-indigo-800 dark:from-white dark:via-blue-200 dark:to-indigo-200 bg-clip-text text-transparent mb-2">
          <lucide-icon [img]="Target" size="28" class="title-icon text-blue-600"></lucide-icon>
          {{ isEditMode() ? 'Editar Meta de Bono' : 'Nueva Meta de Bono' }}
        </h1>
        <p class="subtitle text-gray-600 dark:text-gray-400 text-lg">
          {{ isEditMode() ? 'Modifica la información de la meta de bono' : 'Crea una nueva meta para el cálculo de bonos' }}
        </p>
      </div>
    </div>

    <!-- Error Message -->
    @if (error()) {
      <div
        class="error-message bg-white/75 dark:bg-gray-800/75 backdrop-blur-xl border border-red-200 dark:border-red-800 rounded-xl p-4 mb-6 flex items-center gap-2 shadow">
        <lucide-icon [img]="Target" size="20" class="text-red-500"></lucide-icon>
        <p class="text-red-700 dark:text-red-400">{{ error() }}</p>
      </div>
    }

    <!-- Loading State -->
    @if (loading()) {
      <div
        class="loading-state bg-white/75 dark:bg-gray-800/75 backdrop-blur-xl p-12 rounded-xl shadow-xl border border-white/20 dark:border-gray-700/50 flex flex-col items-center justify-center">
        <div class="loading-spinner w-10 h-10 border-4 border-gray-200 dark:border-gray-600 border-t-blue-600 rounded-full animate-spin mb-4"></div>
        <p class="text-gray-600 dark:text-gray-300">Cargando datos...</p>
      </div>
    } @else {
      <!-- Form -->
      <form [formGroup]="bonusGoalForm" (ngSubmit)="onSubmit()" class="space-y-8">
        <!-- Basic Information -->
        <div
          class="basic-info bg-white/75 dark:bg-gray-800/75 backdrop-blur-xl p-8 rounded-2xl shadow-lg border border-white/20 dark:border-gray-700/50 hover:shadow-2xl transition-all duration-200">
          <h2
            class="section-title flex items-center gap-3 text-2xl font-bold text-gray-900 dark:text-gray-100 mb-6 border-b border-gray-100/70 dark:border-gray-600/60 pb-4">
            <lucide-icon [img]="Target" size="24" class="text-blue-600"></lucide-icon>
            Información Básica
          </h2>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Goal Name -->
            <div class="form-group">
              <label for="goal_name" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                Nombre de la Meta *
              </label>
              <div class="relative">
                <input
                  id="goal_name"
                  type="text"
                  formControlName="goal_name"
                  placeholder="Ej: Meta de Ventas Q1"
                  class="peer w-full pl-4 pr-4 py-3 rounded-xl border border-gray-300/70 dark:border-gray-600/60 bg-white/70 dark:bg-gray-700/50 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500/60 focus:border-blue-500/60 transition-all duration-200 hover:border-gray-400 dark:hover:border-gray-500"
                  [class.border-red-500]="isFieldInvalid('goal_name')"/>
              </div>
              @if (isFieldInvalid('goal_name')) {
                <p class="mt-2 text-sm text-red-600 flex items-center gap-1">
                  <lucide-icon [img]="AlertCircle" size="16"></lucide-icon>
                  {{ getFieldError('goal_name') }}
                </p>
              }
            </div>

            <!-- Bonus Type -->
            <div class="form-group">
              <label for="bonus_type_id" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                Tipo de Bono *
              </label>
              <select
                id="bonus_type_id"
                formControlName="bonus_type_id"
                class="app-select w-full px-4 py-3 rounded-xl border border-gray-300/70 dark:border-gray-600/60 bg-white/70 dark:bg-gray-700/50 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500/60 focus:border-blue-500/60 transition-all duration-200 hover:border-gray-400 dark:hover:border-gray-500"
                [class.border-red-500]="isFieldInvalid('bonus_type_id')">
                <option value="">Seleccionar tipo de bono</option>
                @for (bonusType of getActiveBonusTypes(); track bonusType.bonus_type_id) {
                  <option [value]="bonusType.bonus_type_id">{{ bonusType.type_name }}</option>
                }
              </select>
              @if (isFieldInvalid('bonus_type_id')) {
                <p class="mt-2 text-sm text-red-600 flex items-center gap-1">
                  <lucide-icon [img]="AlertCircle" size="16"></lucide-icon>
                  {{ getFieldError('bonus_type_id') }}
                </p>
              }
            </div>

            <!-- Team (Optional) -->
            <div class="form-group">
              <label for="team_id" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                Equipo (Opcional)
              </label>
              <select
                id="team_id"
                formControlName="team_id"
                class="app-select w-full px-4 py-3 rounded-xl border border-gray-300/70 dark:border-gray-600/60 bg-white/70 dark:bg-gray-700/50 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500/60 focus:border-blue-500/60 transition-all duration-200 hover:border-gray-400 dark:hover:border-gray-500">
                <option value="">Todos los equipos</option>
                @for (team of getActiveTeams(); track team.team_id) {
                  <option [value]="team.team_id">{{ team.team_name }}</option>
                }
              </select>
            </div>

            <!-- Status -->
            <div class="form-group">
              <label for="is_active" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                Estado
              </label>
              <div class="flex items-center gap-3">
                <input
                  id="is_active"
                  type="checkbox"
                  formControlName="is_active"
                  class="w-5 h-5 text-blue-600 border-gray-300 dark:border-gray-600 rounded focus:ring-blue-500 focus:ring-2 bg-white dark:bg-gray-700"/>
                <label for="is_active" class="text-sm text-gray-700 dark:text-gray-300">Meta activa</label>
              </div>
            </div>

            <!-- Description -->
            <div class="md:col-span-2 form-group">
              <label for="description" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                Descripción
              </label>
              <textarea
                id="description"
                formControlName="description"
                rows="3"
                placeholder="Descripción detallada de la meta..."
                class="w-full px-4 py-3 rounded-xl border border-gray-300/70 dark:border-gray-600/60 bg-white/70 dark:bg-gray-700/50 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500/60 focus:border-blue-500/60 transition-all duration-200 hover:border-gray-400 dark:hover:border-gray-500 resize-none"
                [class.border-red-500]="isFieldInvalid('description')"></textarea>
              @if (isFieldInvalid('description')) {
                <p class="mt-2 text-sm text-red-600 flex items-center gap-1">
                  <lucide-icon [img]="AlertCircle" size="16"></lucide-icon>
                  {{ getFieldError('description') }}
                </p>
              }
            </div>
          </div>
        </div>

        <!-- Target Configuration -->
        <div
          class="target-config bg-white/75 dark:bg-gray-800/75 backdrop-blur-xl p-8 rounded-2xl shadow-lg border border-white/20 dark:border-gray-700/50 hover:shadow-2xl transition-all duration-200">
          <h2
            class="section-title flex items-center gap-3 text-2xl font-bold text-gray-900 dark:text-gray-100 mb-6 border-b border-gray-100/70 dark:border-gray-600/60 pb-4">
            <lucide-icon [img]="Target" size="24" class="text-green-600"></lucide-icon>
            Configuración de Metas
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Target Value -->
            <div class="form-group">
              <label for="target_value" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                Valor Meta *
              </label>
              <div class="relative">
                <input
                  id="target_value"
                  type="number"
                  formControlName="target_value"
                  step="0.01"
                  min="0"
                  class="w-full pl-4 pr-4 py-3 rounded-xl border border-gray-300/70 dark:border-gray-600/60 bg-white/70 dark:bg-gray-700/50 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500/60 focus:border-blue-500/60 transition-all duration-200 hover:border-gray-400 dark:hover:border-gray-500"
                  placeholder="0.00"/>
              </div>
              @if (bonusGoalForm.get('target_value')?.invalid && bonusGoalForm.get('target_value')?.touched) {
                <p class="mt-2 text-sm text-red-600 flex items-center gap-1">
                  <lucide-icon [img]="AlertCircle" size="16"></lucide-icon>
                  El valor meta es requerido
                </p>
              }
            </div>

            <!-- Achievement Percentage for 100% -->
            <div class="form-group">
              <label for="achievement_percentage_100" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                % Logro para 100% *
              </label>
              <input
                id="achievement_percentage_100"
                type="number"
                formControlName="achievement_percentage_100"
                step="0.01"
                min="0" max="100"
                class="w-full pl-4 pr-4 py-3 rounded-xl border border-gray-300/70 dark:border-gray-600/60 bg-white/70 dark:bg-gray-700/50 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500/60 focus:border-blue-500/60 transition-all duration-200 hover:border-gray-400 dark:hover:border-gray-500"
                placeholder="100.00"/>
              @if (bonusGoalForm.get('achievement_percentage_100')?.invalid && bonusGoalForm.get('achievement_percentage_100')?.touched) {
                <p class="mt-2 text-sm text-red-600 flex items-center gap-1">
                  <lucide-icon [img]="AlertCircle" size="16"></lucide-icon>
                  El porcentaje es requerido
                </p>
              }
            </div>

            <!-- Achievement Percentage for 150% -->
            <div class="form-group">
              <label for="achievement_percentage_150" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                % Logro para 150%
              </label>
              <input
                id="achievement_percentage_150"
                type="number"
                formControlName="achievement_percentage_150"
                step="0.01"
                min="0" max="200"
                class="w-full pl-4 pr-4 py-3 rounded-xl border border-gray-300/70 dark:border-gray-600/60 bg-white/70 dark:bg-gray-700/50 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500/60 focus:border-blue-500/60 transition-all duration-200 hover:border-gray-400 dark:hover:border-gray-500"
                placeholder="150.00"/>
            </div>
          </div>
        </div>

        <!-- Period Configuration -->
        <div
          class="period-config bg-white/75 dark:bg-gray-800/75 backdrop-blur-xl p-8 rounded-2xl shadow-lg border border-white/20 dark:border-gray-700/50 hover:shadow-2xl transition-all duration-200">
          <h2
            class="section-title flex items-center gap-3 text-2xl font-bold text-gray-900 dark:text-gray-100 mb-6 border-b border-gray-100/70 dark:border-gray-600/60 pb-4">
            <lucide-icon [img]="Calendar" size="24" class="text-purple-600"></lucide-icon>
            Configuración de Período
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Start Date -->
            <div class="form-group">
              <label for="start_date" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                Fecha de Inicio *
              </label>
              <input
                id="start_date"
                type="date"
                formControlName="start_date"
                class="w-full px-4 py-3 rounded-xl border border-gray-300/70 dark:border-gray-600/60 bg-white/70 dark:bg-gray-700/50 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500/60 focus:border-blue-500/60 transition-all duration-200 hover:border-gray-400 dark:hover:border-gray-500"/>
              @if (bonusGoalForm.get('start_date')?.invalid && bonusGoalForm.get('start_date')?.touched) {
                <p class="mt-2 text-sm text-red-600 flex items-center gap-1">
                  <lucide-icon [img]="AlertCircle" size="16"></lucide-icon>
                  La fecha de inicio es requerida
                </p>
              }
            </div>

            <!-- End Date -->
            <div class="form-group">
              <label for="end_date" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                Fecha de Fin *
              </label>
              <input
                id="end_date"
                type="date"
                formControlName="end_date"
                class="w-full px-4 py-3 rounded-xl border border-gray-300/70 dark:border-gray-600/60 bg-white/70 dark:bg-gray-700/50 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500/60 focus:border-blue-500/60 transition-all duration-200 hover:border-gray-400 dark:hover:border-gray-500"/>
              @if (bonusGoalForm.get('end_date')?.invalid && bonusGoalForm.get('end_date')?.touched) {
                <p class="mt-2 text-sm text-red-600 flex items-center gap-1">
                  <lucide-icon [img]="AlertCircle" size="16"></lucide-icon>
                  La fecha de fin es requerida
                </p>
              }
            </div>
          </div>

          <!-- Date Range Validation -->
          @if (!validateDateRange()) {
            <div
              class="mt-4 p-3 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg">
              <p class="text-yellow-800 dark:text-yellow-400 text-sm">
                La fecha de inicio debe ser anterior a la fecha de fin.
              </p>
            </div>
          }
        </div>

        <!-- Form Actions -->
        <div
          class="form-actions bg-white/75 dark:bg-gray-800/75 backdrop-blur-xl p-6 rounded-2xl shadow-lg border border-white/20 dark:border-gray-700/50 flex flex-col sm:flex-row gap-4 justify-end">
          <button
            type="button"
            (click)="onCancel()
            "
            class="cancel-btn px-6 py-3 border-2 border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700 hover:border-gray-400 dark:hover:border-gray-500 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-all duration-200 font-medium">
            Cancelar
          </button>
          <button
            type="submit"
            [disabled]="bonusGoalForm.invalid || loading()"
            class="submit-btn relative overflow-hidden px-8 py-3 rounded-xl text-white bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 font-medium shadow-lg hover:shadow-xl">
            @if (loading()) {
              <span class="flex items-center gap-2">
                <div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                Guardando...
              </span>
            } @else {
              {{ isEditMode() ? 'Actualizar Meta' : 'Crear Meta' }}
            }
          </button>
        </div>
      </form>
    }
  </div>
</div>

<style>
/* Select con flecha, glass y foco consistente */
:host ::ng-deep .app-select{
  appearance:none;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='none' stroke='%2399a2ff' stroke-width='2' viewBox='0 0 24 24'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
  background-repeat:no-repeat;
  background-position:right .9rem center;
  background-size:1rem;
  padding-right:2.4rem!important;
  box-shadow:inset 0 1px 0 rgba(255,255,255,.25), 0 1px 1px rgba(0,0,0,.04);
  backdrop-filter:blur(6px) saturate(140%);
  transition:border-color .2s ease, box-shadow .2s ease, background-color .2s ease;
}
:host ::ng-deep .app-select:hover{ background-color:rgba(255,255,255,.85); }
:host-context(.dark) ::ng-deep .app-select:hover{ background-color:rgba(31,41,55,.55); }
:host ::ng-deep .app-select:focus{
  outline:none;
  border-color:rgba(99,102,241,.75);
  box-shadow:0 0 0 4px rgba(99,102,241,.18), inset 0 1px 0 rgba(255,255,255,.15);
}
/* Opciones (navegadores que lo soportan) */
:host ::ng-deep .app-select option{ background:#0b1220; color:#e5e7eb; }
:host ::ng-deep .app-select option:checked,
:host ::ng-deep .app-select option:hover{ background:#4338ca; color:#fff; }
</style>
