<div class="p-4 sm:p-6 bg-gray-50 dark:bg-gray-900 min-h-screen transition-colors">
  <!-- Header -->
  <div class="flex items-center gap-4 mb-8 p-6 bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 transition-colors">
    <button (click)="onCancel()" class="p-2 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
      <lucide-angular [img]="ArrowLeft" size="24"></lucide-angular>
    </button>
    <div>
      <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Generar Nóminas</h1>
      <p class="text-gray-600 dark:text-gray-400 mt-1">Procesa las nóminas para el período seleccionado</p>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="flex flex-col items-center justify-center p-16 bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 transition-colors">
    <div class="w-12 h-12 border-4 border-gray-200 dark:border-gray-600 border-t-primary-500 rounded-full animate-spin mb-4"></div>
    <p class="text-lg font-semibold text-gray-700 dark:text-gray-300">Cargando empleados...</p>
  </div>

  <!-- Generation Complete State -->
  <div *ngIf="generationComplete()" class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-8 transition-colors">
    <!-- Success Icon -->
    <div class="flex flex-col items-center text-center mb-8">
      <div class="w-20 h-20 rounded-full flex items-center justify-center mb-4"
        [ngClass]="generationResult()?.failed === 0 ? 'bg-green-100 dark:bg-green-900/30' : 'bg-yellow-100 dark:bg-yellow-900/30'">
        <lucide-angular 
          [img]="generationResult()?.failed === 0 ? CheckCircle : AlertCircle" 
          [ngClass]="generationResult()?.failed === 0 ? 'text-green-600 dark:text-green-400' : 'text-yellow-600 dark:text-yellow-400'" 
          size="40">
        </lucide-angular>
      </div>
      <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">
        {{ generationResult()?.failed === 0 ? 'Nóminas Generadas Exitosamente' : 'Generación Completada con Observaciones' }}
      </h2>
      <p class="text-gray-600 dark:text-gray-400">
        {{ getMonthName(payrollForm.get('period_month')?.value) }} {{ payrollForm.get('period_year')?.value }}
      </p>
    </div>

    <!-- Results Summary -->
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8 max-w-2xl mx-auto">
      <div class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-700 rounded-xl p-4 text-center">
        <div class="text-3xl font-bold text-green-600 dark:text-green-400">{{ generationResult()?.successful || 0 }}</div>
        <div class="text-sm text-green-700 dark:text-green-300 mt-1">Generadas</div>
      </div>
      <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-700 rounded-xl p-4 text-center">
        <div class="text-3xl font-bold text-red-600 dark:text-red-400">{{ generationResult()?.failed || 0 }}</div>
        <div class="text-sm text-red-700 dark:text-red-300 mt-1">Fallidas</div>
      </div>
      <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-700 rounded-xl p-4 text-center">
        <div class="text-3xl font-bold text-blue-600 dark:text-blue-400">{{ (generationResult()?.successful || 0) + (generationResult()?.failed || 0) }}</div>
        <div class="text-sm text-blue-700 dark:text-blue-300 mt-1">Total Procesadas</div>
      </div>
    </div>

    <!-- Errors Detail -->
    <div *ngIf="generationResult()?.errors?.length" class="mb-8 max-w-2xl mx-auto">
      <h3 class="text-sm font-semibold text-red-700 dark:text-red-400 mb-3">Detalle de errores:</h3>
      <div class="space-y-2">
        <div *ngFor="let err of generationResult()?.errors" 
          class="flex items-center gap-3 p-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-700 rounded-lg text-sm">
          <lucide-angular [img]="AlertCircle" size="16" class="text-red-500 flex-shrink-0"></lucide-angular>
          <span class="text-red-800 dark:text-red-300">
            <strong>{{ err.employee_name || 'Empleado ' + err.employee_id }}</strong>: {{ err.error }}
          </span>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="flex flex-col sm:flex-row items-center justify-center gap-3">
      <button type="button" (click)="resetForNewGeneration()" 
        class="px-6 py-2.5 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
        Generar Más Nóminas
      </button>
      <button type="button" (click)="goToPayrollList()" 
        class="btn-generate px-6 py-2.5 text-sm font-medium text-white rounded-lg shadow-lg transition-all">
        Ver Listado de Nóminas
      </button>
    </div>
  </div>

  <!-- Form -->
  <div *ngIf="!isLoading && !generationComplete()">
    <form [formGroup]="payrollForm" (ngSubmit)="onSubmit()">
      
      <!-- Tax Parameters Warning / Info -->
      <div *ngIf="taxParamsError()" class="mb-6 p-4 bg-yellow-50 dark:bg-yellow-900/20 border-l-4 border-yellow-400 rounded-lg">
        <div class="flex items-start gap-3">
          <lucide-angular [img]="AlertCircle" class="text-yellow-600 dark:text-yellow-400 flex-shrink-0 mt-0.5" size="20"></lucide-angular>
          <div class="flex-1">
            <h4 class="font-semibold text-yellow-800 dark:text-yellow-300">Parámetros Tributarios No Disponibles</h4>
            <p class="text-sm text-yellow-700 dark:text-yellow-400 mt-1">
              {{ taxParamsError() }}. Los cálculos se realizarán con valores por defecto.
            </p>
            <a 
              routerLink="/hr/tax-parameters" 
              class="inline-flex items-center gap-1 mt-2 text-sm font-medium text-yellow-700 dark:text-yellow-300 hover:text-yellow-800 dark:hover:text-yellow-200 underline"
            >
              Configurar parámetros tributarios →
            </a>
          </div>
        </div>
      </div>

      <!-- Tax Parameters Info Card - Collapsible -->
      <div *ngIf="taxParameters() && !loadingTaxParams()" class="mb-6 bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
        <!-- Header - Clickable to toggle -->
        <button
          type="button"
          (click)="toggleTaxDetails()"
          class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 dark:from-blue-700 dark:to-indigo-700 px-6 py-4 flex items-center justify-between cursor-pointer hover:from-blue-700 hover:to-indigo-700 transition-all"
        >
          <div class="flex items-center gap-3">
            <div class="p-2 bg-white/20 rounded-lg">
              <lucide-angular [img]="Calculator" size="20" class="text-white"></lucide-angular>
            </div>
            <div class="text-left">
              <h3 class="text-lg font-bold text-white">
                Parámetros Tributarios {{ payrollForm.get('period_year')?.value }}
              </h3>
              <p class="text-sm text-blue-100">
                UIT: S/ {{ taxParameters()!.uit_amount | number:'1.0-0' }} · 
                RMV: S/ {{ taxParameters()!.minimum_wage | number:'1.0-0' }} · 
                ONP: {{ taxParameters()!.onp_rate }}%
              </p>
            </div>
          </div>
          <lucide-angular [img]="showTaxDetails() ? ChevronUp : ChevronDown" size="20" class="text-white"></lucide-angular>
        </button>
        
        <!-- Collapsible Content -->
        <div *ngIf="showTaxDetails()" class="p-6">
          <!-- Valores Base -->
          <div class="mb-6">
            <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3 flex items-center gap-2">
              <lucide-angular [img]="DollarSign" size="16" class="text-gray-500"></lucide-angular>
              Valores Base
            </h4>
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
              <div class="bg-gradient-to-br from-emerald-50 to-teal-50 dark:from-emerald-900/20 dark:to-teal-900/20 p-4 rounded-lg border border-emerald-200 dark:border-emerald-700">
                <div class="text-xs text-emerald-600 dark:text-emerald-400 font-medium mb-1">UIT {{ payrollForm.get('period_year')?.value }}</div>
                <div class="text-2xl font-bold text-emerald-900 dark:text-emerald-100">S/ {{ taxParameters()!.uit_amount | number:'1.0-0' }}</div>
              </div>
              <div class="bg-gradient-to-br from-blue-50 to-cyan-50 dark:from-blue-900/20 dark:to-cyan-900/20 p-4 rounded-lg border border-blue-200 dark:border-blue-700">
                <div class="text-xs text-blue-600 dark:text-blue-400 font-medium mb-1">RMV {{ payrollForm.get('period_year')?.value }}</div>
                <div class="text-2xl font-bold text-blue-900 dark:text-blue-100">S/ {{ taxParameters()!.minimum_wage | number:'1.0-0' }}</div>
              </div>
              <div class="bg-gradient-to-br from-purple-50 to-pink-50 dark:from-purple-900/20 dark:to-pink-900/20 p-4 rounded-lg border border-purple-200 dark:border-purple-700">
                <div class="text-xs text-purple-600 dark:text-purple-400 font-medium mb-1">Asig. Familiar</div>
                <div class="text-2xl font-bold text-purple-900 dark:text-purple-100">S/ {{ taxParameters()!.family_allowance | number:'1.0-0' }}</div>
                <div class="text-xs text-purple-600 dark:text-purple-400 mt-1">10% de RMV</div>
              </div>
              <div class="bg-gradient-to-br from-orange-50 to-amber-50 dark:from-orange-900/20 dark:to-amber-900/20 p-4 rounded-lg border border-orange-200 dark:border-orange-700">
                <div class="text-xs text-orange-600 dark:text-orange-400 font-medium mb-1">EsSalud</div>
                <div class="text-2xl font-bold text-orange-900 dark:text-orange-100">{{ taxParameters()!.essalud_rate }}%</div>
                <div class="text-xs text-orange-600 dark:text-orange-400 mt-1">Aporte empleador</div>
              </div>
            </div>
          </div>

          <!-- Pension Systems -->
          <div class="mb-6">
            <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3 flex items-center gap-2">
              <lucide-angular [img]="Percent" size="16" class="text-gray-500"></lucide-angular>
              Sistemas Pensionarios (% del sueldo bruto)
            </h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- ONP -->
              <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg border border-gray-200 dark:border-gray-600">
                <div class="flex items-center justify-between mb-2">
                  <h5 class="font-semibold text-gray-900 dark:text-white">ONP</h5>
                  <span class="px-2 py-1 bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300 text-sm font-bold rounded">
                    {{ taxParameters()!.onp_rate }}%
                  </span>
                </div>
                <p class="text-xs text-gray-500 dark:text-gray-400">Descuento único sobre el sueldo bruto</p>
              </div>

              <!-- AFP -->
              <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg border border-gray-200 dark:border-gray-600">
                <div class="flex items-center justify-between mb-2">
                  <h5 class="font-semibold text-gray-900 dark:text-white">AFP</h5>
                  <span class="px-2 py-1 bg-purple-100 dark:bg-purple-900/50 text-purple-700 dark:text-purple-300 text-xs font-bold rounded">
                    3 descuentos
                  </span>
                </div>
                <div class="space-y-1 text-xs">
                  <div class="flex justify-between items-center">
                    <span class="text-gray-600 dark:text-gray-400">Aporte obligatorio:</span>
                    <span class="font-bold text-gray-900 dark:text-white">{{ taxParameters()!.afp_contribution_rate }}%</span>
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-gray-600 dark:text-gray-400">Seguro:</span>
                    <span class="font-bold text-gray-900 dark:text-white">{{ taxParameters()!.afp_insurance_rate }}%</span>
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-gray-600 dark:text-gray-400">Comisión (varía):</span>
                    <span class="font-bold text-gray-900 dark:text-white">{{ taxParameters()!.afp_prima_commission }}% - {{ taxParameters()!.afp_profuturo_commission }}%</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Income Tax Brackets -->
          <div>
            <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3 flex items-center gap-2">
              <lucide-angular [img]="TrendingUp" size="16" class="text-gray-500"></lucide-angular>
              Impuesto a la Renta - 5ta Categoría
            </h4>
            <div class="bg-gradient-to-br from-slate-50 to-gray-100 dark:from-slate-800 dark:to-gray-800 p-4 rounded-lg border border-slate-200 dark:border-slate-600">
              <div class="text-xs text-slate-600 dark:text-slate-400 mb-3">
                Deducción: <strong>{{ taxParameters()!.rent_tax_deduction_uit }} UIT</strong> 
                (S/ {{ (taxParameters()!.rent_tax_deduction_uit * taxParameters()!.uit_amount) | number:'1.0-0' }} anuales)
              </div>
              
              <div class="overflow-x-auto">
                <table class="w-full text-xs">
                  <thead class="bg-slate-200 dark:bg-slate-700">
                    <tr>
                      <th class="text-left p-2 text-slate-700 dark:text-slate-300">Tramo</th>
                      <th class="text-left p-2 text-slate-700 dark:text-slate-300">Rango Anual (UIT)</th>
                      <th class="text-left p-2 text-slate-700 dark:text-slate-300">Rango Mensual Aprox.</th>
                      <th class="text-right p-2 text-slate-700 dark:text-slate-300">Tasa</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-slate-200 dark:divide-slate-600">
                    <tr class="bg-white dark:bg-slate-800">
                      <td class="p-2 font-medium text-slate-900 dark:text-slate-100">1</td>
                      <td class="p-2 text-slate-600 dark:text-slate-400">Hasta {{ taxParameters()!.rent_tax_tramo1_uit }} UIT</td>
                      <td class="p-2 text-slate-600 dark:text-slate-400">S/ 0 - S/ {{ ((taxParameters()!.rent_tax_tramo1_uit * taxParameters()!.uit_amount) / 12) | number:'1.0-0' }}</td>
                      <td class="p-2 text-right font-bold text-green-600 dark:text-green-400">{{ taxParameters()!.rent_tax_tramo1_rate }}%</td>
                    </tr>
                    <tr class="bg-slate-50 dark:bg-slate-750">
                      <td class="p-2 font-medium text-slate-900 dark:text-slate-100">2</td>
                      <td class="p-2 text-slate-600 dark:text-slate-400">Hasta {{ taxParameters()!.rent_tax_tramo2_uit }} UIT</td>
                      <td class="p-2 text-slate-600 dark:text-slate-400">S/ {{ ((taxParameters()!.rent_tax_tramo1_uit * taxParameters()!.uit_amount) / 12) | number:'1.0-0' }} - S/ {{ ((taxParameters()!.rent_tax_tramo2_uit * taxParameters()!.uit_amount) / 12) | number:'1.0-0' }}</td>
                      <td class="p-2 text-right font-bold text-blue-600 dark:text-blue-400">{{ taxParameters()!.rent_tax_tramo2_rate }}%</td>
                    </tr>
                    <tr class="bg-white dark:bg-slate-800">
                      <td class="p-2 font-medium text-slate-900 dark:text-slate-100">3</td>
                      <td class="p-2 text-slate-600 dark:text-slate-400">Hasta {{ taxParameters()!.rent_tax_tramo3_uit }} UIT</td>
                      <td class="p-2 text-slate-600 dark:text-slate-400">S/ {{ ((taxParameters()!.rent_tax_tramo2_uit * taxParameters()!.uit_amount) / 12) | number:'1.0-0' }} - S/ {{ ((taxParameters()!.rent_tax_tramo3_uit * taxParameters()!.uit_amount) / 12) | number:'1.0-0' }}</td>
                      <td class="p-2 text-right font-bold text-yellow-600 dark:text-yellow-400">{{ taxParameters()!.rent_tax_tramo3_rate }}%</td>
                    </tr>
                    <tr class="bg-slate-50 dark:bg-slate-750">
                      <td class="p-2 font-medium text-slate-900 dark:text-slate-100">4</td>
                      <td class="p-2 text-slate-600 dark:text-slate-400">Hasta {{ taxParameters()!.rent_tax_tramo4_uit }} UIT</td>
                      <td class="p-2 text-slate-600 dark:text-slate-400">S/ {{ ((taxParameters()!.rent_tax_tramo3_uit * taxParameters()!.uit_amount) / 12) | number:'1.0-0' }} - S/ {{ ((taxParameters()!.rent_tax_tramo4_uit * taxParameters()!.uit_amount) / 12) | number:'1.0-0' }}</td>
                      <td class="p-2 text-right font-bold text-orange-600 dark:text-orange-400">{{ taxParameters()!.rent_tax_tramo4_rate }}%</td>
                    </tr>
                    <tr class="bg-white dark:bg-slate-800">
                      <td class="p-2 font-medium text-slate-900 dark:text-slate-100">5</td>
                      <td class="p-2 text-slate-600 dark:text-slate-400">Más de {{ taxParameters()!.rent_tax_tramo4_uit }} UIT</td>
                      <td class="p-2 text-slate-600 dark:text-slate-400">Más de S/ {{ ((taxParameters()!.rent_tax_tramo4_uit * taxParameters()!.uit_amount) / 12) | number:'1.0-0' }}</td>
                      <td class="p-2 text-right font-bold text-red-600 dark:text-red-400">{{ taxParameters()!.rent_tax_tramo5_rate }}%</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              
              <div class="mt-3 p-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-700 rounded-lg">
                <p class="text-xs text-blue-800 dark:text-blue-300">
                  <strong>Nota:</strong> El impuesto se calcula de forma <strong>progresiva</strong>. 
                  Solo se grava lo que excede cada tramo. Sueldos menores a 
                  <strong>S/ {{ ((7 * taxParameters()!.uit_amount) / 12) | number:'1.0-0' }}</strong> 
                  mensuales no pagan impuesto.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Configuración del Período -->
      <div class="mb-8 p-6 bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 transition-colors">
        <div class="flex items-center gap-3 mb-6">
          <div class="p-2 bg-blue-100 dark:bg-blue-900/30 rounded-lg">
            <lucide-angular [img]="Calendar" size="20" class="text-blue-600 dark:text-blue-400"></lucide-angular>
          </div>
          <h3 class="text-xl font-semibold text-gray-900 dark:text-white">
            Configuración del Período
          </h3>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <!-- Mes -->
          <div>
            <label for="period_month" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              Mes <span class="text-red-500">*</span>
            </label>
            <select
              id="period_month"
              formControlName="period_month"
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors"
            >
              <option *ngFor="let month of [1,2,3,4,5,6,7,8,9,10,11,12]" [value]="month">
                {{ getMonthName(month) }}
              </option>
            </select>
          </div>

          <!-- Año -->
          <div>
            <label for="period_year" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              Año <span class="text-red-500">*</span>
            </label>
            <input
              type="number"
              id="period_year"
              formControlName="period_year"
              min="2020"
              max="2030"
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors"
            />
          </div>

          <!-- Fecha de Pago -->
          <div>
            <label for="pay_date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              Fecha de Pago <span class="text-red-500">*</span>
            </label>
            <input
              type="date"
              id="pay_date"
              formControlName="pay_date"
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors"
            />
          </div>
        </div>
      </div>

      <!-- Opciones de Cálculo -->
      <div class="mb-8 p-6 bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 transition-colors">
        <div class="flex items-center gap-3 mb-6">
          <div class="p-2 bg-purple-100 dark:bg-purple-900/30 rounded-lg">
            <lucide-angular [img]="Calculator" size="20" class="text-purple-600 dark:text-purple-400"></lucide-angular>
          </div>
          <h3 class="text-xl font-semibold text-gray-900 dark:text-white">
            Opciones de Cálculo
          </h3>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <label class="flex items-center gap-3 p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg border border-gray-200 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer transition-colors">
            <input
              type="checkbox"
              formControlName="include_commissions"
              class="w-5 h-5 text-primary-500 bg-white dark:bg-gray-600 border-gray-300 dark:border-gray-500 rounded focus:ring-primary-500 focus:ring-2"
            />
            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Incluir Comisiones</span>
          </label>

          <label class="flex items-center gap-3 p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg border border-gray-200 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer transition-colors">
            <input
              type="checkbox"
              formControlName="include_bonuses"
              class="w-5 h-5 text-primary-500 bg-white dark:bg-gray-600 border-gray-300 dark:border-gray-500 rounded focus:ring-primary-500 focus:ring-2"
            />
            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Incluir Bonificaciones</span>
          </label>

          <label class="flex items-center gap-3 p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg border border-gray-200 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer transition-colors">
            <input
              type="checkbox"
              formControlName="include_overtime"
              class="w-5 h-5 text-primary-500 bg-white dark:bg-gray-600 border-gray-300 dark:border-gray-500 rounded focus:ring-primary-500 focus:ring-2"
            />
            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Incluir Horas Extra</span>
          </label>
        </div>
      </div>

      <!-- Selección de Empleados -->
      <div class="mb-8 p-6 bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 transition-colors">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
          <div class="flex items-center gap-3">
            <div class="p-2 bg-green-100 dark:bg-green-900/30 rounded-lg">
              <lucide-angular [img]="Users" size="20" class="text-green-600 dark:text-green-400"></lucide-angular>
            </div>
            <h3 class="text-xl font-semibold text-gray-900 dark:text-white">
              Selección de Empleados
            </h3>
          </div>
          <div class="flex flex-wrap gap-2">
            <button type="button" (click)="selectAllEmployees()" class="px-3 py-2 text-sm font-medium text-primary-600 dark:text-primary-400 hover:text-primary-700 dark:hover:text-primary-300 hover:bg-primary-50 dark:hover:bg-primary-900/20 rounded-lg transition-colors">
              Seleccionar Página
            </button>
            <button type="button" (click)="selectAllEmployeesGlobal()" class="px-3 py-2 text-sm font-medium text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded-lg transition-colors">
              Seleccionar Todos
            </button>
            <button type="button" (click)="clearSelection()" class="px-3 py-2 text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
              Limpiar Selección
            </button>
          </div>
        </div>

        <!-- Resumen de Selección -->
        <div class="mb-6">
          <div class="bg-gradient-to-r from-primary-500 to-purple-600 dark:from-primary-600 dark:to-purple-700 text-white p-6 rounded-xl shadow-lg">
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
              <div>
                <span class="block text-sm font-medium opacity-90 mb-1">Empleados Seleccionados</span>
                <span class="text-3xl font-bold">{{ selectedCount() }}</span>
                <span class="block text-xs opacity-75 mt-1">De {{ totalEmployees() }} totales</span>
              </div>
              <div>
                <span class="block text-sm font-medium opacity-90 mb-1">Total Salarios Base</span>
                <span class="text-3xl font-bold">{{ formatCurrency(estimatedTotal()) }}</span>
                <span class="block text-xs opacity-75 mt-1">Estimado mensual</span>
              </div>
              <div>
                <span class="block text-sm font-medium opacity-90 mb-1">En Esta Página</span>
                <span class="text-2xl font-bold">{{ getSelectedInCurrentPage() }}/{{ employees().length }}</span>
                <span class="block text-xs opacity-75 mt-1">Seleccionados aquí</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Search + Pagination Info -->
        <div class="mb-4 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
          <div class="relative w-full sm:w-72">
            <lucide-angular [img]="Search" size="16" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></lucide-angular>
            <input
              type="text"
              [value]="searchTerm()"
              (input)="onSearchChange($event)"
              placeholder="Buscar por nombre o código..."
              class="w-full pl-9 pr-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors"
            />
          </div>
          <div class="flex items-center gap-2 text-sm">
            <span class="text-gray-600 dark:text-gray-400">
              Mostrando {{ paginationInfo().start }} - {{ paginationInfo().end }} de {{ paginationInfo().total }}
            </span>
            <span *ngIf="selectedCount() > 0" class="px-2 py-1 bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300 text-xs font-semibold rounded-full">
              {{ selectedCount() }} seleccionados
            </span>
          </div>
        </div>

        <!-- Lista de Empleados -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 min-h-[200px] p-4 bg-gray-50 dark:bg-gray-900/50 rounded-lg border border-gray-200 dark:border-gray-600">
          <div
            *ngFor="let employee of filteredEmployees()"
            class="flex items-center gap-4 p-4 bg-white dark:bg-gray-700 rounded-lg border-2 cursor-pointer transition-all hover:shadow-md"
            [ngClass]="isEmployeeSelected(employee.employee_id) 
              ? 'border-primary-500 bg-primary-50 dark:bg-primary-900/20' 
              : 'border-gray-200 dark:border-gray-600 hover:border-gray-300 dark:hover:border-gray-500'"
            (click)="toggleEmployeeSelection(employee.employee_id)"
          >
            <div>
              <input
                type="checkbox"
                [checked]="isEmployeeSelected(employee.employee_id)"
                class="w-5 h-5 text-primary-500 bg-white dark:bg-gray-600 border-gray-300 dark:border-gray-500 rounded focus:ring-primary-500 focus:ring-2"
                readonly
              />
            </div>
            <div class="flex-1 min-w-0">
              <div class="font-semibold text-gray-900 dark:text-white truncate">
                {{ employee.user?.first_name }} {{ employee.user?.last_name }}
              </div>
              <div class="text-sm text-gray-500 dark:text-gray-400">{{ employee.employee_code }}</div>
              <div class="flex items-center gap-1 text-sm font-medium text-green-600 dark:text-green-400 mt-1">
                <lucide-angular [img]="DollarSign" size="14"></lucide-angular>
                {{ formatCurrency(employee.base_salary) }}
              </div>
            </div>
          </div>

          <!-- Empty state when search has no results -->
          <div *ngIf="filteredEmployees().length === 0 && searchTerm()" class="col-span-full flex flex-col items-center justify-center py-12 text-gray-500 dark:text-gray-400">
            <lucide-angular [img]="Search" size="40" class="mb-3 opacity-40"></lucide-angular>
            <p class="text-sm">No se encontraron empleados con "<strong>{{ searchTerm() }}</strong>"</p>
          </div>
        </div>

        <!-- Controles de Paginación -->
        <div *ngIf="totalPages() > 1" class="mt-6 flex items-center justify-between">
          <!-- Mobile -->
          <div class="flex-1 flex justify-between sm:hidden">
            <button
              type="button"
              [disabled]="currentPage() === 1"
              (click)="onPageChange(currentPage() - 1)"
              class="px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
            >
              Anterior
            </button>
            <span class="px-3 py-2 text-sm text-gray-600 dark:text-gray-400">{{ currentPage() }} / {{ totalPages() }}</span>
            <button
              type="button"
              [disabled]="currentPage() === totalPages()"
              (click)="onPageChange(currentPage() + 1)"
              class="px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
            >
              Siguiente
            </button>
          </div>
          
          <!-- Desktop -->
          <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
            <p class="text-sm text-gray-700 dark:text-gray-300">
              Mostrando
              <span class="font-medium">{{ paginationInfo().start }}</span>
              a
              <span class="font-medium">{{ paginationInfo().end }}</span>
              de
              <span class="font-medium">{{ paginationInfo().total }}</span>
              empleados
            </p>
            
            <nav class="inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
              <button
                type="button"
                [disabled]="currentPage() === 1"
                (click)="onPageChange(1)"
                class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-sm font-medium text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                title="Primera página"
              >
                <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M15.707 15.707a1 1 0 01-1.414 0l-5-5a1 1 0 010-1.414l5-5a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 010 1.414zm-6 0a1 1 0 01-1.414 0l-5-5a1 1 0 010-1.414l5-5a1 1 0 011.414 1.414L5.414 10l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                </svg>
              </button>
              
              <button
                type="button"
                [disabled]="currentPage() === 1"
                (click)="onPageChange(currentPage() - 1)"
                class="relative inline-flex items-center px-2 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-sm font-medium text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
              >
                <lucide-angular [img]="ChevronLeft" size="20"></lucide-angular>
              </button>
              
              <button
                type="button"
                *ngFor="let page of getPageNumbers()"
                [ngClass]="currentPage() === page 
                  ? 'z-10 bg-primary-50 dark:bg-primary-900/50 border-primary-500 dark:border-primary-400 text-primary-600 dark:text-primary-300' 
                  : 'bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-600'"
                (click)="onPageChange(page)"
                class="relative inline-flex items-center px-4 py-2 border text-sm font-medium transition-colors"
              >
                {{ page }}
              </button>
              
              <button
                type="button"
                [disabled]="currentPage() === totalPages()"
                (click)="onPageChange(currentPage() + 1)"
                class="relative inline-flex items-center px-2 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-sm font-medium text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
              >
                <lucide-angular [img]="ChevronRight" size="20"></lucide-angular>
              </button>
              
              <button
                type="button"
                [disabled]="currentPage() === totalPages()"
                (click)="onPageChange(totalPages())"
                class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-sm font-medium text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                title="Última página"
              >
                <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0l5 5a1 1 0 010 1.414l-5 5a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414zm6 0a1 1 0 011.414 0l5 5a1 1 0 010 1.414l-5 5a1 1 0 01-1.414-1.414L14.586 10l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
              </button>
            </nav>
          </div>
        </div>
      </div>

      <!-- Notas -->
      <div class="mb-8 p-6 bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 transition-colors">
        <div>
          <label for="notes" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Notas Adicionales
          </label>
          <textarea
            id="notes"
            formControlName="notes"
            placeholder="Notas sobre este proceso de nómina..."
            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors resize-vertical"
            rows="3"
          ></textarea>
        </div>
      </div>

      <!-- Spacer for fixed buttons -->
      <div class="h-28"></div>
    </form>
  </div>
</div>

<!-- Fixed Form Actions -->\n<div *ngIf="!generationComplete()" class="fixed bottom-0 left-0 right-0 sm:left-[240px] bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 shadow-lg z-50 transition-colors">
  <div class="w-full px-4 sm:px-6 py-3">
    <div class="flex items-center justify-between gap-4">
      <!-- Summary Info -->
      <div class="flex items-center gap-3 text-sm min-w-0 overflow-hidden">
        <div class="flex items-center gap-2 flex-shrink-0">
          <lucide-angular [img]="Users" size="16" class="text-blue-600 dark:text-blue-400"></lucide-angular>
          <span class="text-gray-700 dark:text-gray-300">
            <strong class="text-blue-600 dark:text-blue-400">{{ selectedCount() }}</strong> empleados
          </span>
        </div>
        <div class="h-4 w-px bg-gray-300 dark:bg-gray-600 hidden sm:block flex-shrink-0"></div>
        <div class="items-center gap-2 hidden sm:flex flex-shrink-0">
          <lucide-angular [img]="DollarSign" size="16" class="text-green-600 dark:text-green-400"></lucide-angular>
          <span class="text-gray-700 dark:text-gray-300">
            <strong class="text-green-600 dark:text-green-400">{{ formatCurrency(estimatedTotal()) }}</strong>
          </span>
        </div>
      </div>
      
      <!-- Action Buttons -->
      <div class="flex items-center gap-3 flex-shrink-0">
        <button type="button" (click)="onCancel()" class="px-5 py-2.5 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
          Cancelar
        </button>
        
        <button
          type="button"
          (click)="onSubmit()"
          [disabled]="isGenerating || selectedCount() === 0"
          class="btn-generate flex items-center justify-center gap-2 px-5 py-2.5 text-sm font-medium text-white rounded-lg shadow-lg transition-all"
        >
          <lucide-angular *ngIf="!isGenerating" [img]="Send" size="16"></lucide-angular>
          <div *ngIf="isGenerating" class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
          <span *ngIf="!isGenerating">Generar Nóminas ({{ selectedCount() }})</span>
          <span *ngIf="isGenerating">Generando...</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Confirmation Modal -->
<div *ngIf="showConfirmModal()" class="fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
  <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:p-0">
    <!-- Background overlay -->
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 dark:bg-gray-900 dark:bg-opacity-80 transition-opacity" (click)="cancelConfirmation()"></div>

    <!-- Center trick for alignment -->
    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

    <!-- Modal panel -->
    <div class="relative inline-block align-bottom bg-white dark:bg-gray-800 rounded-xl text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full">
      <div class="bg-white dark:bg-gray-800 px-6 pt-5 pb-4">
        <div class="sm:flex sm:items-start">
          <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 dark:bg-blue-900/30 sm:mx-0 sm:h-10 sm:w-10">
            <lucide-angular [img]="Info" class="text-blue-600 dark:text-blue-400" size="24"></lucide-angular>
          </div>
          <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left flex-1">
            <h3 class="text-lg leading-6 font-semibold text-gray-900 dark:text-white" id="modal-title">
              Confirmar Generación de Nóminas
            </h3>
            <div class="mt-4">
              <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                Estás a punto de generar nóminas para el período seleccionado. Por favor revisa los detalles:
              </p>
              
              <!-- Summary Grid -->
              <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4 mb-4">
                <div class="grid grid-cols-2 gap-4 text-sm">
                  <div>
                    <span class="text-gray-500 dark:text-gray-400">Período:</span>
                    <span class="ml-2 font-semibold text-gray-900 dark:text-white">
                      {{ getMonthName(payrollForm.get('period_month')?.value) }} {{ payrollForm.get('period_year')?.value }}
                    </span>
                  </div>
                  <div>
                    <span class="text-gray-500 dark:text-gray-400">Fecha de Pago:</span>
                    <span class="ml-2 font-semibold text-gray-900 dark:text-white">
                      {{ payrollForm.get('pay_date')?.value | date:'dd/MM/yyyy' }}
                    </span>
                  </div>
                  <div>
                    <span class="text-gray-500 dark:text-gray-400">Empleados:</span>
                    <span class="ml-2 font-semibold text-blue-600 dark:text-blue-400">
                      {{ selectedCount() }}
                    </span>
                  </div>
                  <div>
                    <span class="text-gray-500 dark:text-gray-400">Total Estimado:</span>
                    <span class="ml-2 font-semibold text-green-600 dark:text-green-400">
                      {{ formatCurrency(estimatedTotal()) }}
                    </span>
                  </div>
                </div>
              </div>
              
              <!-- Options -->
              <div class="space-y-2 text-sm">
                <div class="flex items-center gap-2">
                  <lucide-angular 
                    [img]="payrollForm.get('include_commissions')?.value ? CheckCircle : AlertCircle" 
                    [ngClass]="payrollForm.get('include_commissions')?.value ? 'text-green-600' : 'text-gray-400'" 
                    size="16"
                  ></lucide-angular>
                  <span class="text-gray-700 dark:text-gray-300">
                    {{ payrollForm.get('include_commissions')?.value ? 'Incluye' : 'No incluye' }} comisiones
                  </span>
                </div>
                <div class="flex items-center gap-2">
                  <lucide-angular 
                    [img]="payrollForm.get('include_bonuses')?.value ? CheckCircle : AlertCircle" 
                    [ngClass]="payrollForm.get('include_bonuses')?.value ? 'text-green-600' : 'text-gray-400'" 
                    size="16"
                  ></lucide-angular>
                  <span class="text-gray-700 dark:text-gray-300">
                    {{ payrollForm.get('include_bonuses')?.value ? 'Incluye' : 'No incluye' }} bonificaciones
                  </span>
                </div>
                <div class="flex items-center gap-2">
                  <lucide-angular 
                    [img]="payrollForm.get('include_overtime')?.value ? CheckCircle : AlertCircle" 
                    [ngClass]="payrollForm.get('include_overtime')?.value ? 'text-green-600' : 'text-gray-400'" 
                    size="16"
                  ></lucide-angular>
                  <span class="text-gray-700 dark:text-gray-300">
                    {{ payrollForm.get('include_overtime')?.value ? 'Incluye' : 'No incluye' }} horas extra
                  </span>
                </div>
              </div>
              
              <!-- Tax Parameters Info -->
              <div *ngIf="taxParameters()" class="mt-4 p-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-700 rounded-lg">
                <div class="flex items-start gap-2">
                  <lucide-angular [img]="TrendingUp" class="text-blue-600 dark:text-blue-400 flex-shrink-0 mt-0.5" size="16"></lucide-angular>
                  <div class="text-xs text-blue-800 dark:text-blue-300">
                    <div class="font-semibold mb-1">Parámetros Tributarios {{ payrollForm.get('period_year')?.value }}</div>
                    <div class="flex gap-3 flex-wrap">
                      <span>UIT: S/ {{ taxParameters()!.uit_amount | number:'1.0-0' }}</span>
                      <span>RMV: S/ {{ taxParameters()!.minimum_wage | number:'1.0-0' }}</span>
                      <span>ONP: {{ taxParameters()!.onp_rate }}%</span>
                    </div>
                  </div>
                </div>
              </div>
              
              <div *ngIf="taxParamsError()" class="mt-4 p-3 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700 rounded-lg">
                <div class="flex items-start gap-2">
                  <lucide-angular [img]="AlertCircle" class="text-yellow-600 dark:text-yellow-400 flex-shrink-0 mt-0.5" size="16"></lucide-angular>
                  <p class="text-xs text-yellow-800 dark:text-yellow-300">
                    Se usarán parámetros por defecto ya que no hay parámetros configurados para {{ payrollForm.get('period_year')?.value }}.
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="bg-gray-50 dark:bg-gray-700 px-6 py-4 flex flex-col-reverse sm:flex-row sm:justify-end gap-3">
        <button
          type="button"
          (click)="cancelConfirmation()"
          class="w-full sm:w-auto px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-600 border border-gray-300 dark:border-gray-500 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-500 focus:ring-2 focus:ring-gray-500 transition-colors"
        >
          Cancelar
        </button>
        <button
          type="button"
          (click)="confirmGeneration()"
          [disabled]="isGenerating"
          class="btn-generate w-full sm:w-auto flex items-center justify-center gap-2 px-4 py-2 text-sm font-medium text-white rounded-lg focus:ring-2 focus:ring-primary-500 transition-colors"
        >
          <lucide-angular [img]="Send" size="16" *ngIf="!isGenerating"></lucide-angular>
          <div *ngIf="isGenerating" class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
          <span>{{ isGenerating ? 'Generando...' : 'Confirmar y Generar' }}</span>
        </button>
      </div>
    </div>
  </div>
</div>